<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Particle Hunter â€” v0.7.26 (Hybrid + Connectivity + Verb fix)</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Meiryo,sans-serif;background:#f7f7f9;margin:0;color:#222}
  header{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;position:sticky;top:0;z-index:10}
  .head{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  h1{margin:0;font-size:1.05rem}
  main{max-width:980px;margin:0 auto;padding:1.25rem}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .sentence{font-size:1.6rem;user-select:none}
  .token{display:inline-block;border-radius:6px;cursor:pointer;transition:background .12s,box-shadow .12s}
  body:not(.noHover) .token:hover{background:#f0f9ff;box-shadow:inset 0 0 0 1px #bae6fd}
  .picked{background:#e0f2fe;box-shadow:inset 0 0 0 1px #7dd3fc}
  .good{background:#dcfce7!important;box-shadow:inset 0 0 0 1px #86efac!important}
  .bad{box-shadow:inset 0 0 0 2px #f87171!important}
  .miss{background:#fecaca!important;box-shadow:inset 0 0 0 1px #ef4444!important}
  button{border:1px solid #d1d5db;background:#fff;padding:.55rem .8rem;border-radius:10px;cursor:pointer;font-size:.95rem}
  button.primary{background:#111827;color:#fff;border-color:#111827}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .5rem;border:1px solid #e5e7eb;border-radius:999px;font-size:.85rem;background:#fff}
  .stats{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
  .muted{color:#6b7280;font-size:.9rem}
  .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:space-between}
  .banner{display:none;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;padding:.6rem .8rem;border-radius:10px;margin:.75rem 0}
  .banner.show{display:block}
  .banner.good{border-color:#bbf7d0;background:#f0fdf4;color:#065f46}
  .debug{font-family:ui-monospace,monospace;font-size:.85rem;white-space:pre-wrap;background:#f9fafb;border:1px dashed #e5e7eb;padding:.5rem;border-radius:8px;color:#374151}
  .next-success{box-shadow:0 0 0 2px #22c55e inset}
  .next-warn{box-shadow:0 0 0 2px #fbbf24 inset}
  #breakdownBox.bd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}
  #err{display:none;margin:0;padding:.6rem .8rem;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px}
  #err.show{display:block}
</style>
</head>
<body class="noHover">
<header>
  <div class="head">
    <h1>Particle Hunter <span class="muted">v0.7.26</span> <span class="pill" id="modePill">Core</span></h1>
    <button id="toggleDebugBtn">Debug Mode: <span id="debugState">ON</span></button>
  </div>
</header>

<main>
  <p id="err"></p>

  <div id="introCard" class="card intro">
    <h2>ğŸŒ¸ The Goal</h2>
    <p><strong>Think in Japanese by reading Japanese.</strong> English relies on word order; Japanese relies on tiny glue-words. Train your eyes to find them first.</p>
    <div class="example" style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:.6rem .8rem;margin:.5rem 0;font-family:ui-monospace,monospace;font-size:.95rem;">
      çŠ¬<strong>ãŒ</strong> äºº<strong>ã‚’</strong> å™›ã‚“ã <br/>äºº<strong>ã‚’</strong> çŠ¬<strong>ãŒ</strong> å™›ã‚“ã <br/>
      <span class="muted">Both read â€œThe dog bit the man.â€ The glue-words anchor roles.</span>
    </div>
    <button id="startBtn" class="primary">Start</button>
  </div>

  <div class="card" id="gameCard">
    <div class="row">
      <div class="muted"><strong>Goal:</strong> Click all glue-words in the sentence, then press <strong>Check</strong>.</div>
      <div class="pill"><span>Keys:</span> <strong>Space</strong> check/next Â· <strong>C</strong> check Â· <strong>N</strong> next</div>
    </div>

    <div id="cargoBanner" class="banner" role="alert"><strong>Hey, you left cargo on the platform!</strong></div>
    <div id="streamBanner" class="banner" role="alert" style="display:none;"></div>
    <div id="levelBanner" class="banner good" role="status">Mastery achieved â€” Level 2 unlocked.</div>

    <div class="sentence" id="sentence"></div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap;">
      <button id="checkBtn" class="primary">Check</button>
      <button id="nextBtn">Next</button>
      <button id="revealBtn">Reveal answer</button>
      <button id="resetBtn">Reset</button>
      <button id="toggleParticlesBtn">Show particle list</button>
      <button id="toggleMyNotesBtn">Show my notes</button>
    </div>

    <div class="stats" id="stats"></div>
    <div id="breakdownBox" class="debug" style="display:none;margin-top:.5rem;"></div>

    <div class="notes" id="notesBlock" style="display:none;">
      <h4>Notes</h4><ul id="notesList"></ul>
    </div>

    <div class="card" id="particleListCard" style="display:none;margin-top:.75rem;">
      <strong>Particle reference</strong>
      <div class="muted">Multi-character first, then singles. Ambiguities like ã€Œã«ã¯ã€ are treated as ã« + ã¯.</div>
      <ul class="muted">
        <li>Multi-char: ã‹ã‚‰, ã¾ã§, ã‚ˆã‚Š, ã£ã¦, ã—ã‹, ãªã©</li>
        <li>Single-char: ã¯, ãŒ, ã‚’, ã«, ã¸, ã§, ã¨, ã‚‚, ã‚„, ã®</li>
      </ul>
    </div>

    <div class="myNotes" id="myNotesBlock" style="display:none;margin-top:.75rem;">
      <h4>My Notes (unlocked this session)</h4><ul id="myNotesList"></ul>
    </div>
  </div>

  <div class="card" id="settingsCard">
    <strong>Settings</strong>
    <div class="muted">Hard Mode splits non-particles into characters; multi-character particles stay grouped. Stacked notes are always on.</div>
    <div style="display:grid;gap:.4rem;margin-top:.5rem;">
      <label><input type="checkbox" id="hardMode"> Hard mode</label>
      <label><input type="checkbox" id="hoverHints"> Enable hover highlights</label>
      <label><input type="checkbox" id="strictMode"> Strict mode (disable Reveal)</label>
      <label><input type="checkbox" id="trapMode"> Trap mode (extra distractors)</label>
      <label><input type="checkbox" id="showCounts" checked> Show particle count in debug</label>
      <label><input type="checkbox" id="persistNotes"> Keep stacked gloss notes (session)</label>
      <label><input type="checkbox" id="autoProgress" checked> Auto-progress (streak-based)</label>
      <label><input type="checkbox" id="betaGloss"> Beta: Particle gloss + sentence meaning</label>
      <label><input type="checkbox" id="betaSkeleton"> Beta: Skeleton view</label>
      <label><input type="checkbox" id="betaTrain"> Beta: Train-car breakdown</label>
      <label><input type="checkbox" id="tatoebaStream"> Stream: Tatoeba (hybrid)</label>
      <label>Batch size
        <select id="tatoebaBatch"><option>10</option><option selected>25</option><option>50</option></select>
      </label>
      <label>Max JP length
        <select id="tatoebaMaxLen"><option>16</option><option selected>24</option><option>36</option><option>60</option></select>
      </label>
    </div>
  </div>

  <div class="card" id="debugCard">
    <strong>Debug</strong>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0;">
      <button id="copyDebugBtn">Copy debug snapshot</button>
      <button id="factoryBtn">Factory Reset (first-run)</button>
    </div>
    <div id="debugArea" class="debug">Ready.</div>
  </div>
</main>

<script>
/* ===== Visible error so failures never look blank ===== */
function showErr(msg){var el=document.getElementById('err');el.textContent="Script error: "+msg;el.className="show";}

/* ===== Optional external tokenizer hook ===== */
function tokenizerHook(sentence){return null;}

/* ===== Core data ===== */
var CORE=[
  {text:"ç§ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚"},
  {text:"æ˜æ—¥å­¦æ ¡ã§ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã€‚"},
  {text:"é§…ã¾ã§æ­©ã„ã¦è¡Œãã€‚"},
  {text:"å‹é”ã¨æ˜ ç”»ã‚’è¦‹ãŸã€‚"},
  {text:"å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚ŠãŸã€‚"},
  {text:"æ˜¼ã”é£¯ã«ã‚«ãƒ¬ãƒ¼ã‚’é£Ÿã¹ãŸã€‚"},
  {text:"çŒ«ãŒåº­ã«ã„ã‚‹ã€‚"},
  {text:"æ±äº¬ã¸å¼•ã£è¶Šã—ãŸã€‚"},
  {text:"ä¸ƒæ™‚ã«èµ·ãã¦ã€ä¼šç¤¾ã¸è¡Œãã€‚"},
  {text:"ã“ã®æœ¬ã¯å¤ªéƒã«ã‚ã’ãŸã€‚"},
  {text:"è¦ªã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚"},
  {text:"ç‰›ä¹³ã—ã‹é£²ã¾ãªã„ã€‚"},
  {text:"é§…ã‹ã‚‰å®¶ã¾ã§èµ°ã£ãŸã€‚"},
  {text:"å…ˆç”Ÿã¨ã‚‚è©±ã—ãŸã€‚"},
  {text:"æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦å­¦ã¶ã€‚"},
  {text:"æ˜æ—¥ã‚‚ä»•äº‹ãŒã‚ã‚‹ã€‚"},
  {text:"ã“ã‚Œã¯ç§ã®ã§ã™ã€‚"},
  {text:"å…¬åœ’ã§å­ä¾›ã¨éŠã¶ã€‚"}
];
var TRAPS=[
  {text:"ã«ã‚“ã˜ã‚“ã‚’é£Ÿã¹ã‚‹ã€‚",exceptions:[{start:0,end:1}]},
  {text:"ãƒãƒ¼ãƒˆã«ã®ã‚Šã‚’ã¤ã‘ãŸã€‚",exceptions:[{start:4,end:5}]},
  {text:"ã§ãã‚‹ã ã‘æ—©ãå¸°ã‚‹ã€‚",exceptions:[{start:0,end:1}]},
  {text:"ã“ã®æœ¬ã‚’èª­ã‚“ã ã€‚",exceptions:[{start:0,end:2}]},
  {text:"ãã®æ˜ ç”»ã¯é¢ç™½ã„ã€‚",exceptions:[{start:0,end:2}]}
];

var MULTI=["ã‹ã‚‰","ã¾ã§","ã‚ˆã‚Š","ã£ã¦","ã—ã‹","ãªã©"];
var SINGLE=["ã¯","ãŒ","ã‚’","ã«","ã¸","ã§","ã¨","ã‚‚","ã‚„","ã®"];
var ALL=[].concat(MULTI,SINGLE);

var GLOSS={"ã¯":"topic / lens","ãŒ":"identifier / subject","ã‚’":"direct object","ã«":"target / time / existence","ã¸":"direction (towards)","ã§":"place of action / means","ã¨":"and / with / quotative","ã‚‚":"also / even","ã‚„":"non-exhaustive â€˜andâ€™","ã®":"possessive / attributive","ã‹ã‚‰":"from / since","ã¾ã§":"until / as far as","ã‚ˆã‚Š":"than (comparison)","ã—ã‹":"only (â€¦ãªã„)","ã£ã¦":"informal quotative/topic","ãªã©":"such as / etc."};

var DEMO_EXCEPTIONS=["ã“ã®","ãã®","ã‚ã®","ã©ã®","ã“ã‚“ãª","ãã‚“ãª","ã‚ã‚“ãª","ã©ã‚“ãª"];
var SEQ_EXCEPTIONS=["ã§ã™","ã§ã—ãŸ"];
var WORD_EXCEPTIONS=["ãŠã«ãã‚Š","ã®ã‚Š","ã¯ãªã—","ã«ã‚“ã˜ã‚“","ã§ãã‚‹"];

// Meanings used by beta â€œSentence meaningâ€
var MEANINGS={
  "é§…ã¾ã§æ­©ã„ã¦è¡Œãã€‚":"(I) walk to the station.",
  "ã“ã®æœ¬ã¯å¤ªéƒã«ã‚ã’ãŸã€‚":"(I) gave this book to TarÅ.",
  "æ˜¼ã”é£¯ã«ã‚«ãƒ¬ãƒ¼ã‚’é£Ÿã¹ãŸã€‚":"(I) ate curry for lunch.",
  "å…¬åœ’ã§å­ä¾›ã¨éŠã¶ã€‚":"(I) play with children at the park.",
  "ç§ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚":"(I) am studying Japanese.",
  "å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚ŠãŸã€‚":"(I) borrowed a book at the library.",
  "çŒ«ãŒåº­ã«ã„ã‚‹ã€‚":"A cat is in the yard.",
  "é§…ã‹ã‚‰å®¶ã¾ã§èµ°ã£ãŸã€‚":"(I) ran from the station to home.",
  "æ˜æ—¥å­¦æ ¡ã§ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã€‚":"There is a test at school tomorrow."
};

/* ===== Persistence & state ===== */
var KEY="phSettingsV0726";
var state={
  idx:0,hard:false,hover:false,strict:false,trap:false,showCounts:true,
  cargoShown:false,perGlossSeen:{},rounds:[],level2Ready:false,levelBannerDismissed:false,
  persistNotes:false,glossLog:[],autoProgress:true,introSeen:false,myNotesOpen:false,debugMode:true,

  // Hybrid stream
  tatoebaStream:false,tatoebaBatch:25,tatoebaMaxLen:24,tatoebaCache:[],tatoebaLastAt:0,
  tatoebaStatus:"unknown",tatoebaLastErr:"",

  // Beta toggles
  betaGloss:false,betaSkeleton:false,betaTrain:false,

  _storageDisabled:false
};
function save(){if(state._storageDisabled)return;try{localStorage.setItem(KEY,JSON.stringify(state));}catch(e){state._storageDisabled=true;}}
function load(){try{var s=localStorage.getItem(KEY);if(s)Object.assign(state,JSON.parse(s));}catch(e){}}
function factoryReset(){if(!confirm("Factory Reset?"))return;try{localStorage.removeItem(KEY);}catch(e){}location.reload();}

/* ===== Stream connectivity helpers ===== */
function showStreamBanner(msg){
  var el=document.getElementById("streamBanner");
  if(!el)return;
  el.innerHTML="<strong>Live stream unavailable.</strong> "+(msg||"Use a local server (not file://) or check your connection.");
  el.style.display="block";
}
function hideStreamBanner(){
  var el=document.getElementById("streamBanner"); if(el) el.style.display="none";
}
async function testTatoebaConnectivity(timeoutMs){
  if(location.protocol==="file:"){
    state.tatoebaStatus="blocked";
    state.tatoebaLastErr="Blocked on file:// â€” run a local server (e.g., python3 -m http.server)."; save(); return false;
  }
  if(navigator && navigator.onLine===false){
    state.tatoebaStatus="offline"; state.tatoebaLastErr="Offline"; save(); return false;
  }
  var ctrl=new AbortController(); var to=setTimeout(function(){ctrl.abort();},timeoutMs||3000);
  try{
    var probe="https://tatoeba.org/en/api_v0/search?from=jpn&sort=random&page=1";
    var res=await fetch(probe,{mode:"cors",signal:ctrl.signal});
    clearTimeout(to);
    if(!res.ok){ state.tatoebaStatus=(navigator.onLine===false)?"offline":"blocked"; state.tatoebaLastErr="HTTP "+res.status; save(); return false; }
    state.tatoebaStatus="ok"; state.tatoebaLastErr=""; save(); return true;
  }catch(e){
    clearTimeout(to);
    state.tatoebaStatus=(navigator.onLine===false)?"offline":"blocked";
    state.tatoebaLastErr=(e&&e.message)?e.message:"Fetch failed"; save(); return false;
  }
}

/* ===== Bind settings (sticky) ===== */
function bindSettings(){
  ["hardMode","hoverHints","strictMode","trapMode","showCounts","persistNotes","autoProgress",
   "betaGloss","betaSkeleton","betaTrain","tatoebaStream"].forEach(function(id){
    var el=document.getElementById(id); if(!el)return;
    if(id==="tatoebaStream"){
      el.addEventListener("change",async function(e){
        state.tatoebaStream=!!e.target.checked; save();
        if(state.tatoebaStream){
          hideStreamBanner();
          var ok=await testTatoebaConnectivity(3000);
          if(!ok){ showStreamBanner(state.tatoebaLastErr); state.tatoebaStream=false; save(); syncUI(); }
          else{ refillTatoebaIfNeeded(); }
        }else{ hideStreamBanner(); }
      });
    }else{
      el.addEventListener("change",function(e){
        state[id]=!!e.target.checked; save();
        if(id==="trapMode"){ state.idx=0; }
        if(id==="hardMode"){ render(true);} else { syncUI(); }
      });
    }
  });
  document.getElementById("tatoebaBatch").addEventListener("change",function(e){
    state.tatoebaBatch=parseInt(e.target.value,10)||25; save();
  });
  document.getElementById("tatoebaMaxLen").addEventListener("change",function(e){
    state.tatoebaMaxLen=parseInt(e.target.value,10)||24; save();
  });
}

/* ===== Helpers & tokenization ===== */
var IDLE_CUTOFF=12.0;
function reserveWords(sentence,used,reserved){
  for(var wi=0;wi<WORD_EXCEPTIONS.length;wi++){
    var w=WORD_EXCEPTIONS[wi],idx=0;
    while(true){var pos=sentence.indexOf(w,idx);if(pos===-1)break;
      reserved.push({start:pos,end:pos+w.length});
      for(var k=0;k<w.length;k++)used[pos+k]=true;
      idx=pos+w.length;
    }
  }
}
function exceptsFor(item){return item.exceptions||[];}
function isExcepted(i,len,exceptions){if(!exceptions.length)return false;var s=i,e=i+len;for(var k=0;k<exceptions.length;k++){var ex=exceptions[k];if(Math.max(s,ex.start)<Math.min(e,ex.end))return true;}return false;}
function annotate(sentence,hardMode,exceptions){
  var ext=tokenizerHook(sentence); if(Array.isArray(ext))return ext;
  var marks=[],used=new Array(sentence.length).fill(false),reserved=[];
  reserveWords(sentence,used,reserved);
  for(var i=0;i<sentence.length;i++){for(var d=0;d<DEMO_EXCEPTIONS.length;d++){var w=DEMO_EXCEPTIONS[d];if(sentence.startsWith(w,i)){reserved.push({start:i,end:i+w.length});for(var k=0;k<w.length;k++)used[i+k]=true;i+=w.length-1;break;}}}
  for(var j=0;j<sentence.length;j++){for(var s=0;s<SEQ_EXCEPTIONS.length;s++){var w2=SEQ_EXCEPTIONS[s];if(sentence.startsWith(w2,j)){reserved.push({start:j,end:j+w2.length});for(var k2=0;k2<w2.length;k2++)used[j+k2]=true;j+=w2.length-1;break;}}}
  function markAt(ii,list){
    for(var li=0;li<list.length;li++){
      var p=list[li];
      if(sentence.startsWith(p,ii)){
        if(isExcepted(ii,p.length,reserved)||isExcepted(ii,p.length,exceptions))continue;
        var ok=true;for(var kk=0;kk<p.length;kk++){if(used[ii+kk]){ok=false;break;}}
        if(!ok)continue;
        for(var kk2=0;kk2<p.length;kk2++)used[ii+kk2]=true;
        marks.push({start:ii,end:ii+p.length,text:p});return p.length;
      }
    } return 0;
  }
  for(var x=0;x<sentence.length;x++){var adv=markAt(x,MULTI);if(adv)x+=adv-1;}
  for(var y=0;y<sentence.length;y++){if(used[y])continue;var ch=sentence[y];
    if(SINGLE.indexOf(ch)>-1 && !isExcepted(y,1,reserved) && !isExcepted(y,1,exceptions)){
      used[y]=true;marks.push({start:y,end:y+1,text:ch});
    }
  }
  marks.sort(function(a,b){return a.start-b.start;});
  var tokens=[],idx=0;
  for(var m=0;m<marks.length;m++){
    var mk=marks[m];
    if(idx<mk.start){
      var chunk=sentence.slice(idx,mk.start);
      if(hardMode){for(var ci=0;ci<chunk.length;ci++)tokens.push({text:chunk[ci],isParticle:false});}
      else{tokens.push({text:chunk,isParticle:false});}
    }
    tokens.push({text:sentence.slice(mk.start,mk.end),isParticle:true});
    idx=mk.end;
  }
  if(idx<sentence.length){
    var tail=sentence.slice(idx);
    if(hardMode){for(var ti=0;ti<tail.length;ti++)tokens.push({text:tail[ti],isParticle:false});}
    else{tokens.push({text:tail,isParticle:false});}
  }
  return tokens;
}

/* ===== Train-car breakdown ===== */
var JP=/[ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ³ãƒ¼]/;
var EN_NOUN={"æ˜¼ã”é£¯":"lunch","ã‚«ãƒ¬ãƒ¼":"curry","é§…":"station","å®¶":"house","æœ¬":"book","å›³æ›¸é¤¨":"library","çŒ«":"cat","åº­":"yard","å…¬åœ’":"park","å­ä¾›":"children","æ—¥æœ¬èª":"Japanese","ä¼šç¤¾":"company","å¤ªéƒ":"TarÅ","æ˜æ—¥":"tomorrow","å­¦æ ¡":"school","é€±æœ«":"weekend"};
var ROLE={"ã«":"target","ã‚’":"object","ã§":"place/means","ã¸":"direction","ãŒ":"subject","ã¯":"topic","ã®":"of/â€™s","ã‹ã‚‰":"from","ã¾ã§":"to","ã‚ˆã‚Š":"than","ã—ã‹":"only","ã£ã¦":"quot./topic","ãªã©":"etc."};
var EN_VERB={"é£Ÿã¹ãŸ":"ate","èµ°ã£ãŸ":"ran","è¦‹ãŸ":"saw/watched","è¡Œã£ãŸ":"went","è¡Œã":"go","æ¥ãŸ":"came","æ¥ã‚‹":"come","éŠã¶":"play","å€Ÿã‚ŠãŸ":"borrowed","å‹‰å¼·ã—ã¦ã„ã‚‹":"am studying","ã‚ã’ãŸ":"gave","ã„ã‚‹":"is/are","ã‚ã‚‹":"there is/are","å¼•ã£è¶Šã—ãŸ":"moved"};
function carGlueLines(tokens){
  var lines=[];
  // host + particle
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i]; if(!t.isParticle)continue;
    var hostParts=[],j=i-1;
    while(j>=0 && !tokens[j].isParticle && JP.test(tokens[j].text)){hostParts.unshift(tokens[j].text);break;}
    var hostJP=(hostParts.join("")||"â€¦").replace(/\s+/g,"");
    var hostEN=EN_NOUN[hostJP]||hostJP;
    var role=ROLE[t.text]||"particle";
    lines.push(hostJP+" "+t.text+" â€” "+hostEN+" ("+role+")");
  }
  // final verb/predicate (robust)
  (function(){
    if(!tokens.length)return;
    var k=tokens.length-1;
    while(k>=0 && !tokens[k].isParticle && /[ã€‚ï¼ï¼Ÿ!?]/.test(tokens[k].text)){k--;}
    var tail=[];
    while(k>=0 && !tokens[k].isParticle && JP.test(tokens[k].text)){
      tail.unshift(tokens[k].text);
      if(k-1>=0 && tokens[k-1].isParticle)break;
      k--;
    }
    if(!tail.length)return;
    var core=tail.join(""); var clean=core.replace(/[ã€‚ï¼ï¼Ÿ!?]+$/,"");
    var en=EN_VERB[clean]||"verb";
    var endPunct=/[ã€‚ï¼ï¼Ÿ!?]$/.test(tokens[tokens.length-1].text)?"ã€‚":"";
    lines.push(clean+endPunct+" â€” "+en);
  })();
  return lines;
}

/* ===== Hybrid stream (Tatoeba) ===== */
var PARTICLES=[].concat(MULTI,SINGLE);
function hasParticles(s){for(var i=0;i<PARTICLES.length;i++){if(s.indexOf(PARTICLES[i])>-1)return true;}return false;}
function buildSeenSet(){
  var seen=Object.create(null);
  for(var i=0;i<CORE.length;i++)seen[CORE[i].text]=1;
  if(Array.isArray(state.tatoebaCache))for(var j=0;j<state.tatoebaCache.length;j++)seen[state.tatoebaCache[j].text]=1;
  return seen;
}
function parseTatoeba(json,maxLen){
  var out=[]; if(!json||!json.results)return out;
  for(var i=0;i<json.results.length;i++){
    var r=json.results[i], jp=(r.text||r.sentence||"").trim(), lang=r.lang||r.language||r.from||"";
    if(lang!=="jpn"||!jp)continue;
    if(maxLen && jp.replace(/\s+/g,"").length>maxLen)continue;
    if(!hasParticles(jp))continue;
    var en=""; if(r.translations&&r.translations.length){
      for(var t=0;t<r.translations.length;t++){var tr=r.translations[t]; if((tr.lang||tr.language)==="eng"&&tr.text){en=tr.text.trim();break;}}
    }
    if(jp.charAt(jp.length-1)!=="ã€‚")jp+="ã€‚";
    out.push({text:jp,meaning:en});
  } return out;
}
function tatoebaUrl(page){var p=page||1;return "https://tatoeba.org/en/api_v0/search?from=jpn&sort=random&trans_filter=limit&orphans=no&has_audio=no&page="+p;}
async function refillTatoebaIfNeeded(){
  if(!state.tatoebaStream)return;
  if(!Array.isArray(state.tatoebaCache))state.tatoebaCache=[];
  if(state.tatoebaCache.length>=state.tatoebaBatch)return;
  var now=Date.now(); if(now-(state.tatoebaLastAt||0)<2000)return;
  try{
    var want=state.tatoebaBatch,maxLen=state.tatoebaMaxLen||24,seen=buildSeenSet(),added=0,tries=0;
    while(added<want && tries<6){
      tries++; var page=1+Math.floor(Math.random()*20);
      var res=await fetch(tatoebaUrl(page),{mode:"cors"}); if(!res.ok)break;
      var items=parseTatoeba(await res.json(),maxLen);
      for(var i=0;i<items.length && added<want;i++){
        var it=items[i]; if(seen[it.text])continue; seen[it.text]=1;
        state.tatoebaCache.push(it);
        if(it.meaning && !MEANINGS[it.text])MEANINGS[it.text]=it.meaning;
        added++;
      }
    }
    state.tatoebaLastAt=Date.now(); save();
  }catch(e){/* silent: offline/CORS */}
}

/* ===== UI state ===== */
var tokens=[],picked=new Set();
function updatePill(){document.getElementById("modePill").textContent=state.trap?"Brutal (Trap)":"Core";}
function renderNotes(items){
  var block=document.getElementById("notesBlock"),list=document.getElementById("notesList");
  list.innerHTML=""; if(!items.length){block.style.display="none";return;}
  for(var i=0;i<items.length;i++){var li=document.createElement("li");li.textContent=items[i];list.appendChild(li);}
  block.style.display="block";
}
function buildUnlockedNotes(){var keys=[];for(var k in state.perGlossSeen){if(state.perGlossSeen[k])keys.push(k);}var order=MULTI.concat(SINGLE);keys.sort(function(a,b){return order.indexOf(a)-order.indexOf(b);});var out=[];for(var i=0;i<keys.length;i++){var key=keys[i];out.push(key+" = "+(GLOSS[key]||"particle"));}return out;}
function renderMyNotes(){var list=document.getElementById("myNotesList");list.innerHTML="";var all=buildUnlockedNotes();if(!all.length){var li=document.createElement("li");li.textContent="No notes unlocked yet.";list.appendChild(li);return;}for(var i=0;i<all.length;i++){var li2=document.createElement("li");li2.textContent=all[i];list.appendChild(li2);}}
function resetNextBtn(){var n=document.getElementById("nextBtn");n.classList.remove("next-success");n.classList.remove("next-warn");}
function clearAccPills(){var pills=document.querySelectorAll("#stats .pill");for(var i=0;i<pills.length;i++){var txt=(pills[i].textContent||"").trim();if(txt.indexOf("Acc ")===0)pills[i].remove();}}
function syncUI(){
  document.body.classList.toggle("noHover",!state.hover);
  document.getElementById("revealBtn").disabled=state.strict;
  document.getElementById("hardMode").checked=!!state.hard;
  document.getElementById("hoverHints").checked=!!state.hover;
  document.getElementById("strictMode").checked=!!state.strict;
  document.getElementById("trapMode").checked=!!state.trap;
  document.getElementById("showCounts").checked=!!state.showCounts;
  document.getElementById("persistNotes").checked=!!state.persistNotes;
  document.getElementById("autoProgress").checked=!!state.autoProgress;
  document.getElementById("betaGloss").checked=!!state.betaGloss;
  document.getElementById("betaSkeleton").checked=!!state.betaSkeleton;
  document.getElementById("betaTrain").checked=!!state.betaTrain;
  document.getElementById("tatoebaStream").checked=!!state.tatoebaStream;
  document.getElementById("tatoebaBatch").value=String(state.tatoebaBatch||25);
  document.getElementById("tatoebaMaxLen").value=String(state.tatoebaMaxLen||24);

  updatePill();
  document.getElementById("debugCard").style.display="block";
  document.getElementById("settingsCard").style.display="block";
  document.getElementById("debugState").textContent=state.debugMode?"ON":"OFF";

  document.getElementById("myNotesBlock").style.display=state.myNotesOpen?"block":"none";
  document.getElementById("toggleMyNotesBtn").textContent=state.myNotesOpen?"Hide my notes":"Show my notes";

  var dbg=document.getElementById("debugArea");
  if(state.showCounts){
    var count=tokens.filter(function(t){return t.isParticle;}).length;
    dbg.textContent="v0.7.26 | Particles: "+count;
  }else{dbg.textContent="v0.7.26";}
  // stream status note
  var st=state.tatoebaStatus||"unknown"; var note=" | Stream: "+st+(state.tatoebaLastErr?(" ("+state.tatoebaLastErr+")"):"");
  dbg.textContent+=note;
}

/* ===== Bank ===== */
function currentBank(){
  var base=CORE.slice();
  if(state.tatoebaStream && Array.isArray(state.tatoebaCache) && state.tatoebaCache.length){
    var stream=state.tatoebaCache.map(function(it){return {text:it.text};});
    var out=[],i=0,j=0; while(i<base.length||j<stream.length){ if(i<base.length)out.push(base[i++]); if(j<stream.length)out.push(stream[j++]); }
    base=out;
  }
  if(state.trap) base=base.concat(TRAPS);
  return base;
}

/* ===== Round flow ===== */
function render(force){
  if(typeof force==="undefined")force=false;
  clearAccPills(); var bd=document.getElementById("breakdownBox"); if(bd)bd.style.display="none";
  var bank=currentBank(); if(!bank.length){document.getElementById("sentence").textContent="(no sentences)";return;}
  if(!force) state.idx=(state.idx+1)%bank.length;
  var item=bank[state.idx], sentence=item.text; state._lastSentence=sentence;
  tokens=annotate(sentence,state.hard,exceptsFor(item)); picked.clear();
  var c=document.getElementById("sentence"); c.innerHTML="";
  for(var i=0;i<tokens.length;i++){
    (function(i){
      var t=tokens[i],sp=document.createElement("span");
      sp.className="token"; sp.textContent=t.text;
      sp.addEventListener("pointerdown",function(){
        if(sp.classList.contains("good")||sp.classList.contains("bad")||sp.classList.contains("miss"))return;
        if(picked.has(i)){picked.delete(i);sp.classList.remove("picked");}
        else{picked.add(i);sp.classList.add("picked");}
      });
      c.appendChild(sp);
    })(i);
  }
  document.getElementById("checkBtn").disabled=false;
  document.getElementById("nextBtn").disabled=true;
  resetNextBtn(); document.getElementById("cargoBanner").classList.remove("show");
  syncUI();
  if(state.tatoebaStream){ refillTatoebaIfNeeded(); }
}
function scoreRound(){
  var tp=0,fp=0,fn=0,spans=[].slice.call(document.querySelectorAll("#sentence .token")),newGlosses=[];
  function addGloss(key){ if(ALL.indexOf(key)>-1 && !state.perGlossSeen[key]){ var gloss=GLOSS[key]||"particle"; var line=key+" = "+gloss; newGlosses.push(line); state.perGlossSeen[key]=true; } }
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i],p=picked.has(i);
    if(t.isParticle && p){tp++;spans[i].classList.add("good");addGloss(t.text);}
    else if(!t.isParticle && p){fp++;spans[i].classList.add("bad");}
    else if(t.isParticle && !p){fn++;spans[i].classList.add("miss");addGloss(t.text);}
  }
  var trueP=tokens.filter(function(t){return t.isParticle;}).length;
  var acc=trueP===0?(picked.size===0?100:0):(tp/(tp+fp+fn||1))*100;
  var accP=document.createElement("span");accP.className="pill";accP.textContent="Acc "+acc.toFixed(1)+"%";document.getElementById("stats").appendChild(accP);
  if(fn>0 && !state.cargoShown){document.getElementById("cargoBanner").classList.add("show");state.cargoShown=true;}
  if(state.persistNotes){for(var g=0;g<newGlosses.length;g++){if(state.glossLog.indexOf(newGlosses[g])===-1)state.glossLog.push(newGlosses[g]);}renderNotes(state.glossLog);}else{renderNotes(newGlosses);}
  if(state.myNotesOpen)renderMyNotes();

  // Beta breakdowns
  var want=state.debugMode&&(state.betaGloss||state.betaSkeleton||state.betaTrain);
  var box=document.getElementById("breakdownBox");
  if(box){
    if(!want){box.style.display="none";box.textContent="";}
    else{
      var sentence=state._lastSentence||""; var nat=MEANINGS[sentence]||"(meaning coming soon)"; var sections=[];
      var uniq=[],order=MULTI.concat(SINGLE);
      for(var i2=0;i2<tokens.length;i2++){var t2=tokens[i2]; if(t2.isParticle && uniq.indexOf(t2.text)===-1)uniq.push(t2.text);}
      uniq.sort(function(a,b){return order.indexOf(a)-order.indexOf(b);});
      if(state.betaGloss){
        var glossLines=uniq.length?("â€¢ "+uniq.map(function(p){return p+" = "+(GLOSS[p]||"particle");}).join("\nâ€¢ ")):"â€”";
        sections.push("Particles in this sentence\n"+glossLines+"\n\nSentence meaning\n"+nat);
      }
      if(state.betaSkeleton){
        var rows=[]; if(sentence.indexOf("ã¾ã§")>-1){var seg=sentence.split("ã¾ã§")[0];var piece=(seg.slice(-6)+"ã¾ã§").replace(/.*?([ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ³ãƒ¼]+ã¾ã§)$/,'$1');rows.push(piece+" â†’ endpoint â€œto/until â€¦â€");}
        if(sentence.indexOf("ã«")>-1)rows.push("â€¦ã« â†’ time/target/existence");
        if(sentence.indexOf("ã§")>-1)rows.push("â€¦ã§ â†’ place of action / by means");
        sections.push("Skeleton view\n"+(rows.length?("â€¢ "+rows.join("\nâ€¢ ")):"â€”"));
      }
      if(state.betaTrain){ sections.push("Train-car breakdown\n"+"â€¢ "+carGlueLines(tokens).join("\nâ€¢ ")); }
      box.classList.add("bd"); box.style.display="block"; box.textContent=sections.join("\n\n");
    }
  }

  var next=document.getElementById("nextBtn");
  document.getElementById("checkBtn").disabled=true; next.disabled=false; resetNextBtn();
  if(fp===0 && fn===0){next.classList.add("next-success");}else{next.classList.add("next-warn");}
  save(); syncUI();
}
function revealAnswer(){
  var spans=[].slice.call(document.querySelectorAll("#sentence .token"));
  for(var i=0;i<tokens.length;i++){if(tokens[i].isParticle)spans[i].classList.add("miss");}
  document.getElementById("checkBtn").disabled=true; var next=document.getElementById("nextBtn");
  next.disabled=false; resetNextBtn(); next.classList.add("next-warn");
}
function resetRound(){
  picked.clear(); var nodes=[].slice.call(document.querySelectorAll("#sentence .token"));
  for(var i=0;i<nodes.length;i++){nodes[i].classList.remove("picked","good","bad","miss");}
  document.getElementById("cargoBanner").classList.remove("show"); var bd=document.getElementById("breakdownBox"); if(bd)bd.style.display="none"; resetNextBtn();
}

/* ===== Controls ===== */
document.getElementById("checkBtn").onclick=scoreRound;
document.getElementById("nextBtn").onclick=function(){render(false);};
document.getElementById("revealBtn").onclick=revealAnswer;
document.getElementById("resetBtn").onclick=resetRound;
document.getElementById("toggleParticlesBtn").onclick=function(){var card=document.getElementById("particleListCard");card.style.display=card.style.display==="none"?"block":"none";};
document.getElementById("toggleMyNotesBtn").onclick=function(){state.myNotesOpen=!state.myNotesOpen;save();if(state.myNotesOpen)renderMyNotes();syncUI();};
document.getElementById("factoryBtn").addEventListener("click",factoryReset);
document.getElementById("copyDebugBtn").addEventListener("click",function(){
  var payload={version:"v0.7.26",sentence:(currentBank()[state.idx]||{}).text,settings:state,tokens:tokens.map(function(t){return {t:t.text,p:t.isParticle};}),picked:Array.from(picked),glossLog:state.glossLog};
  var text=JSON.stringify(payload,null,2);
  if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){document.getElementById("debugArea").textContent="Copied debug snapshot:\n"+text;}).catch(function(){document.getElementById("debugArea").textContent="Copy failed. Here it is:\n"+text;});}
  else{document.getElementById("debugArea").textContent="Clipboard not available. Here it is:\n"+text;}
});
document.getElementById("toggleDebugBtn").onclick=function(){state.debugMode=!state.debugMode;save();syncUI();};
document.addEventListener("keydown",function(e){
  var tag=(e.target&&e.target.tagName)?e.target.tagName.toLowerCase():""; if(tag==="input"||tag==="textarea")return;
  var k=(e.key||"").toLowerCase();
  if(k===" "){e.preventDefault(); if(!document.getElementById("checkBtn").disabled)scoreRound(); else if(!document.getElementById("nextBtn").disabled)render(false); return;}
  if(k==="c" && !document.getElementById("checkBtn").disabled)scoreRound();
  if(k==="n" && !document.getElementById("nextBtn").disabled)render(false);
});

/* ===== Boot ===== */
try{
  load();
  (function boot(){
    document.getElementById("gameCard").style.display="block";
    document.getElementById("settingsCard").style.display="block";
    document.getElementById("debugCard").style.display="block";
    document.getElementById("startBtn").onclick=function(){state.introSeen=true;save();document.getElementById("introCard").style.display="none";render(true);};
    if(state.introSeen){document.getElementById("introCard").style.display="none";}
    bindSettings(); syncUI(); render(true);
  })();
}catch(e){console.error(e);showErr(e.message||String(e));}
</script>
</body>
</html>
