<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Particle Hunter â€” v0.7.29 (Auto-Submit + Timing-Based Progression)</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Meiryo,sans-serif;background:#f7f7f9;margin:0;color:#222}
  header{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;position:sticky;top:0;z-index:10}
  .head{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  h1{margin:0;font-size:1.05rem}
  main{max-width:980px;margin:0 auto;padding:1.25rem}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .sentence{font-size:1.6rem;user-select:none}
  .token{display:inline-block;border-radius:6px;cursor:pointer;transition:background .12s,box-shadow .12s}
  body:not(.noHover) .token:hover{background:#f0f9ff;box-shadow:inset 0 0 0 1px #bae6fd}
  .picked{background:#e0f2fe;box-shadow:inset 0 0 0 1px #7dd3fc}
  .good{background:#dcfce7!important;box-shadow:inset 0 0 0 1px #86efac!important}
  .bad{box-shadow:inset 0 0 0 2px #f87171!important}
  .miss{background:#fecaca!important;box-shadow:inset 0 0 0 1px #ef4444!important}
  button{border:1px solid #d1d5db;background:#fff;padding:.55rem .8rem;border-radius:10px;cursor:pointer;font-size:.95rem}
  button.primary{background:#111827;color:#fff;border-color:#111827}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .5rem;border:1px solid #e5e7eb;border-radius:999px;font-size:.85rem;background:#fff}
  .stats{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
  .muted{color:#6b7280;font-size:.9rem}
  .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:space-between}
  .banner{display:none;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;padding:.6rem .8rem;border-radius:10px;margin:.75rem 0}
  .banner.show{display:block}
  .banner.good{border-color:#bbf7d0;background:#f0fdf4;color:#065f46}
  .debug{font-family:ui-monospace,monospace;font-size:.85rem;white-space:pre-wrap;background:#f9fafb;border:1px dashed #e5e7eb;padding:.5rem;border-radius:8px;color:#374151}
  .next-success{box-shadow:0 0 0 2px #22c55e inset}
  .next-warn{box-shadow:0 0 0 2px #fbbf24 inset}
  #breakdownBox.bd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}
  #err{display:none;margin:0;padding:.6rem .8rem;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px}
  #err.show{display:block}
</style>
</head>
<body class="noHover">
<header>
  <div class="head">
    <h1>Particle Hunter <span class="muted">v0.7.29</span> <span class="pill" id="modePill">Core</span></h1>
    <button id="toggleDebugBtn">Debug Mode: <span id="debugState">ON</span></button>
  </div>
</header>

<main>
  <p id="err"></p>

  <div id="introCard" class="card intro">
    <h2>ğŸŒ¸ The Goal</h2>
    <p><strong>Think in Japanese by reading Japanese.</strong> English relies on word order; Japanese relies on tiny glue-words. Train your eyes to find them first.</p>
    <div class="example" style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:.6rem .8rem;margin:.5rem 0;font-family:ui-monospace,monospace;font-size:.95rem;">
      çŠ¬<strong>ãŒ</strong> äºº<strong>ã‚’</strong> å™›ã‚“ã <br/>äºº<strong>ã‚’</strong> çŠ¬<strong>ãŒ</strong> å™›ã‚“ã <br/>
      <span class="muted">Both read â€œThe dog bit the man.â€ The glue-words anchor roles.</span>
    </div>
    <button id="startBtn" class="primary">Start</button>
  </div>

  <div class="card" id="gameCard">
    <div class="row">
      <div class="muted"><strong>Goal:</strong> Click all particles as fast as you can! Auto-advances when complete.</div>
      <div class="pill"><span>Keys:</span> <strong>Space</strong> or <strong>N</strong> next sentence</div>
    </div>

    <div id="cargoBanner" class="banner" role="alert"><strong>Hey, you left cargo on the platform!</strong></div>
    <div id="streamBanner" class="banner" role="alert" style="display:none;"></div>
    <div id="levelBanner" class="banner good" role="status">Mastery achieved â€” Level 2 unlocked.</div>

    <div class="sentence" id="sentence"></div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap;">
      <button id="nextBtn">Next</button>
      <button id="showBreakdownBtn" disabled>Show breakdown</button>
      <button id="toggleParticlesBtn">Show particle list</button>
      <button id="toggleMyNotesBtn">Show my notes</button>
    </div>

    <div class="stats" id="stats"></div>
    <div id="breakdownBox" class="card" style="display:none;margin-top:.75rem;padding:1rem;background:#f9fafb;">
      <strong>Sentence Breakdown</strong>
      <div id="breakdownContent" style="margin-top:.5rem;font-family:ui-monospace,monospace;"></div>
    </div>

    <div class="notes" id="notesBlock" style="display:none;">
      <h4>Notes</h4><ul id="notesList"></ul>
    </div>

    <div class="card" id="particleListCard" style="display:none;margin-top:.75rem;">
      <strong>Particle reference</strong>
      <div class="muted">Multi-character first, then singles. Ambiguities like ã€Œã«ã¯ã€ are treated as ã« + ã¯.</div>
      <ul class="muted">
        <li>Multi-char: ã‹ã‚‰, ã¾ã§, ã‚ˆã‚Š, ã£ã¦, ã—ã‹, ãªã©</li>
        <li>Single-char: ã¯, ãŒ, ã‚’, ã«, ã¸, ã§, ã¨, ã‚‚, ã‚„, ã®</li>
      </ul>
    </div>

    <div class="myNotes" id="myNotesBlock" style="display:none;margin-top:.75rem;">
      <h4>My Notes (unlocked this session)</h4><ul id="myNotesList"></ul>
    </div>
  </div>

  <div class="card" id="settingsCard">
    <strong>Settings</strong>
    <div class="muted">Auto-advances on completion. Level up by improving speed (avg time/particle). Level 1-2: grouped. Level 3-4: character-split.</div>
    <div style="display:grid;gap:.4rem;margin-top:.5rem;">
      <label><input type="checkbox" id="hoverHints"> Enable hover highlights</label>
      <label><input type="checkbox" id="showCounts" checked> Show timing stats in debug</label>
      <label><input type="checkbox" id="persistNotes"> Keep stacked gloss notes (session)</label>
    </div>
  </div>

  <div class="card" id="debugCard">
    <strong>Debug</strong>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0;">
      <button id="copyDebugBtn">Copy debug snapshot</button>
      <button id="factoryBtn">Factory Reset (first-run)</button>
    </div>
    <div id="debugArea" class="debug">Ready.</div>
  </div>
</main>

<script>
/* ===== Visible error so failures never look blank ===== */
function showErr(msg){var el=document.getElementById('err');el.textContent="Script error: "+msg;el.className="show";}

/* ===== Optional external tokenizer hook ===== */
function tokenizerHook(sentence){return null;}

/* ===== Core data ===== */
var CORE=[
  {text:"ç§ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚"},
  {text:"æ˜æ—¥å­¦æ ¡ã§ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã€‚"},
  {text:"é§…ã¾ã§æ­©ã„ã¦è¡Œãã€‚"},
  {text:"å‹é”ã¨æ˜ ç”»ã‚’è¦‹ãŸã€‚"},
  {text:"å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚ŠãŸã€‚"},
  {text:"æ˜¼ã”é£¯ã«ã‚«ãƒ¬ãƒ¼ã‚’é£Ÿã¹ãŸã€‚"},
  {text:"çŒ«ãŒåº­ã«ã„ã‚‹ã€‚"},
  {text:"æ±äº¬ã¸å¼•ã£è¶Šã—ãŸã€‚"},
  {text:"ä¸ƒæ™‚ã«èµ·ãã¦ã€ä¼šç¤¾ã¸è¡Œãã€‚"},
  {text:"ã“ã®æœ¬ã¯å¤ªéƒã«ã‚ã’ãŸã€‚"},
  {text:"è¦ªã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚"},
  {text:"ç‰›ä¹³ã—ã‹é£²ã¾ãªã„ã€‚"},
  {text:"é§…ã‹ã‚‰å®¶ã¾ã§èµ°ã£ãŸã€‚"},
  {text:"å…ˆç”Ÿã¨ã‚‚è©±ã—ãŸã€‚"},
  {text:"æ—¥æœ¬ã®æ–‡åŒ–ã«ã¤ã„ã¦å­¦ã¶ã€‚"},
  {text:"æ˜æ—¥ã‚‚ä»•äº‹ãŒã‚ã‚‹ã€‚"},
  {text:"ã“ã‚Œã¯ç§ã®ã§ã™ã€‚"},
  {text:"å…¬åœ’ã§å­ä¾›ã¨éŠã¶ã€‚"}
];
var TRAPS=[
  {text:"ã«ã‚“ã˜ã‚“ã‚’é£Ÿã¹ã‚‹ã€‚",exceptions:[{start:0,end:1}]},
  {text:"ãƒãƒ¼ãƒˆã«ã®ã‚Šã‚’ã¤ã‘ãŸã€‚",exceptions:[{start:4,end:5}]},
  {text:"ã§ãã‚‹ã ã‘æ—©ãå¸°ã‚‹ã€‚",exceptions:[{start:0,end:1}]},
  {text:"ã“ã®æœ¬ã‚’èª­ã‚“ã ã€‚",exceptions:[{start:0,end:2}]},
  {text:"ãã®æ˜ ç”»ã¯é¢ç™½ã„ã€‚",exceptions:[{start:0,end:2}]}
];

// Extended sentence banks by level
var LEVEL1_EXT=[
  {text:"çŠ¬ãŒèµ°ã‚‹ã€‚"},{text:"é›¨ãŒé™ã‚‹ã€‚"},{text:"èŠ±ã‚’è¦‹ã‚‹ã€‚"},{text:"æ°´ã‚’é£²ã‚€ã€‚"},
  {text:"å‹é”ã«ä¼šã†ã€‚"},{text:"å­¦æ ¡ã¸è¡Œãã€‚"},{text:"æœ¬ãŒå¥½ãã ã€‚"},{text:"è»Šã§æ¥ãŸã€‚"},
  {text:"æ¯ã¨è²·ã„ç‰©ã™ã‚‹ã€‚"},{text:"å…„ã‚‚æ¥ã‚‹ã€‚"},{text:"å¦¹ã®é„ã ã€‚"},{text:"å®¶ã‹ã‚‰å‡ºã‚‹ã€‚"},
  {text:"é§…ã¾ã§æ­©ãã€‚"},{text:"éŸ³æ¥½ã‚’èãã€‚"},{text:"éƒ¨å±‹ãŒæš—ã„ã€‚"},{text:"æœã”é£¯ã‚’é£Ÿã¹ã‚‹ã€‚"},
  {text:"å…ˆç”ŸãŒæ•™ãˆã‚‹ã€‚"},{text:"çµµã‚’æãã€‚"},{text:"çª“ã‚’é–‹ã‘ã‚‹ã€‚"},{text:"å‹é”ã¨éŠã¶ã€‚"}
];
var LEVEL2_EXT=[
  {text:"æ¯ãŒæ–™ç†ã‚’ä½œã£ã¦ã„ã‚‹ã€‚"},{text:"å…„ã¯æ¯æ—¥èµ°ã£ã¦ã„ã‚‹ã€‚"},{text:"å¦¹ã‚‚å®¿é¡Œã‚’ã™ã‚‹ã€‚"},
  {text:"çŠ¬ãŒå…¬åœ’ã§éŠã‚“ã§ã„ã‚‹ã€‚"},{text:"ç§ã¯æœ¬ã‚’å›³æ›¸é¤¨ã§å€Ÿã‚ŠãŸã€‚"},{text:"å‹é”ã¨æ˜ ç”»é¤¨ã¸è¡Œã£ãŸã€‚"},
  {text:"çˆ¶ãŒä¼šç¤¾ã‹ã‚‰å¸°ã£ã¦ããŸã€‚"},{text:"å½¼å¥³ã¯æ—¥æœ¬èªãŒä¸Šæ‰‹ã ã€‚"},{text:"æ˜¨æ—¥ã‚‚é›¨ãŒé™ã£ãŸã€‚"},
  {text:"çŒ«ãŒé­šã‚’é£Ÿã¹ã¦ã„ã‚‹ã€‚"},{text:"å¼Ÿã¯å­¦æ ¡ãŒå«Œã„ã ã€‚"},{text:"å§‰ãŒæ‰‹ç´™ã‚’æ›¸ã„ãŸã€‚"},
  {text:"å½¼ã¯æ±äº¬ã‹ã‚‰æ¥ãŸã€‚"},{text:"ç§ã‚‚æ­ŒãŒå¥½ãã ã€‚"},{text:"å…ˆç”ŸãŒæœ¬ã‚’èª­ã‚“ã§ã„ã‚‹ã€‚"},
  {text:"æ¯ãŒè²·ã„ç‰©ã«è¡Œã£ãŸã€‚"},{text:"å…„ãŒè»Šã‚’é‹è»¢ã™ã‚‹ã€‚"},{text:"å‹é”ã®å®¶ã¸è¡Œãã€‚"},
  {text:"æ¯æ—¥å…¬åœ’ã‚’æ•£æ­©ã™ã‚‹ã€‚"},{text:"é§…ã‹ã‚‰èµ°ã£ã¦æ¥ãŸã€‚"}
];
var LEVEL3_EXT=[
  {text:"å½¼ã¯æ¯æœä¸ƒæ™‚ã«èµ·ãã¦ã€ä¼šç¤¾ã¸è¡Œãã€‚"},{text:"ç§ã®æ¯ã¯æ–™ç†ãŒä¸Šæ‰‹ã§ã€æ¯æ—¥ç¾å‘³ã—ã„ã‚‚ã®ã‚’ä½œã‚‹ã€‚"},
  {text:"å‹é”ãŒå›³æ›¸é¤¨ã§å‹‰å¼·ã—ã¦ã„ã‚‹æ™‚ã€ç§ã¯å®¶ã§å¯ã¦ã„ãŸã€‚"},{text:"å…„ã¯æ±äº¬ã®å¤§å­¦ã§çµŒæ¸ˆã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚"},
  {text:"æ˜¨æ—¥é§…å‰ã§å‹é”ã«ä¼šã£ã¦ã€ä¸€ç·’ã«æ˜ ç”»ã‚’è¦‹ãŸã€‚"},{text:"å½¼å¥³ã¯æ—¥æœ¬èªã¨è‹±èªãŒè©±ã›ã‚‹ã€‚"},
  {text:"çˆ¶ãŒä¼šç¤¾ã‹ã‚‰å¸°ã£ã¦ããŸã‚‰ã€å¤•é£¯ã‚’é£Ÿã¹ã‚‹ã€‚"},{text:"å¦¹ã¯æ¯æ—¥ãƒ”ã‚¢ãƒã‚’ç·´ç¿’ã—ã¦ã„ã‚‹ãŒã€ã¾ã ä¸Šæ‰‹ã§ã¯ãªã„ã€‚"},
  {text:"å…¬åœ’ã§çŠ¬ã¨éŠã‚“ã§ã„ã‚‹å­ä¾›ãŸã¡ã‚’è¦‹ãŸã€‚"},{text:"æ˜æ—¥ã¯å‹é”ã®å®¶ã§ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ãŒã‚ã‚‹ã€‚"},
  {text:"ç§ã¯æœã”é£¯ã«ãƒ‘ãƒ³ã¨ç‰›ä¹³ã‚’é£Ÿã¹ãŸã€‚"},{text:"å½¼ã¯æœ¬ã‚’èª­ã‚€ã®ãŒå¥½ãã§ã€æ¯é€±å›³æ›¸é¤¨ã«è¡Œãã€‚"},
  {text:"æ¯ãŒè²·ã„ç‰©ã‹ã‚‰å¸°ã£ã¦ãã¦ã€æ–™ç†ã‚’å§‹ã‚ãŸã€‚"},{text:"å…„ãŒæ–°ã—ã„è»Šã‚’è²·ã£ãŸã®ã§ã€ç§ã‚‚ä¹—ã›ã¦ã‚‚ã‚‰ã£ãŸã€‚"},
  {text:"é§…ã¾ã§æ­©ã„ã¦è¡Œãã‚ˆã‚Šã€ãƒã‚¹ã§è¡Œãæ–¹ãŒæ—©ã„ã€‚"}
];
var LEVEL4_EXT=[
  {text:"ç§ã®çˆ¶ã¯æ¯æœå…­æ™‚ã«èµ·ãã¦ã€ä¼šç¤¾ã«è¡Œãå‰ã«ã‚¸ãƒ§ã‚®ãƒ³ã‚°ã‚’ã—ã¦ã„ã‚‹ã€‚"},
  {text:"å‹é”ãŒæ±äº¬ã‹ã‚‰å¤§é˜ªã¾ã§æ–°å¹¹ç·šã§è¡Œã£ãŸæ™‚ã€ç§ã‚‚ä¸€ç·’ã«è¡ŒããŸã‹ã£ãŸãŒã€ä»•äº‹ãŒã‚ã£ã¦è¡Œã‘ãªã‹ã£ãŸã€‚"},
  {text:"å½¼å¥³ã¯æ—¥æœ¬èªã®å‹‰å¼·ã‚’å§‹ã‚ã¦ã‹ã‚‰ä¸‰å¹´ã«ãªã‚‹ãŒã€ã¾ã æ¼¢å­—ã‚’èª­ã‚€ã®ãŒé›£ã—ã„ã¨è¨€ã£ã¦ã„ã‚‹ã€‚"},
  {text:"æ˜¨æ—¥å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚Šã‚ˆã†ã¨æ€ã£ãŸãŒã€èª­ã¿ãŸã„æœ¬ãŒå…¨éƒ¨è²¸ã—å‡ºã•ã‚Œã¦ã„ãŸã®ã§ã€è«¦ã‚ã¦å¸°ã£ãŸã€‚"},
  {text:"æ¯ãŒæ–™ç†ã‚’ä½œã£ã¦ã„ã‚‹é–“ã«ã€ç§ã¯éƒ¨å±‹ã‚’æƒé™¤ã—ã¦ã€çˆ¶ã¯åº­ã§èŠ±ã«æ°´ã‚’ã‚„ã£ã¦ã„ãŸã€‚"},
  {text:"å…„ã¯å¤§å­¦ã‚’å’æ¥­ã—ã¦ã‹ã‚‰æ±äº¬ã®ä¼šç¤¾ã§åƒã„ã¦ã„ã‚‹ãŒã€æ¯é€±æœ«ã¯å®Ÿå®¶ã«å¸°ã£ã¦ãã‚‹ã€‚"},
  {text:"å½¼ã¯æ—¥æœ¬èªãŒä¸Šæ‰‹ã«è©±ã›ã‚‹ã ã‘ã§ã¯ãªãã€ä¸­å›½èªã‚‚éŸ“å›½èªã‚‚å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚"},
  {text:"æ˜æ—¥å‹é”ã¨æ˜ ç”»ã‚’è¦‹ã«è¡Œãäºˆå®šã ã£ãŸãŒã€é›¨ãŒé™ã‚Šãã†ãªã®ã§ã€å®¶ã§ã‚²ãƒ¼ãƒ ã‚’ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚"},
  {text:"ç§ã¯æœã”é£¯ã‚’é£Ÿã¹ã¦ã‹ã‚‰å­¦æ ¡ã«è¡ŒããŒã€å¼Ÿã¯é£Ÿã¹ãªã„ã§è¡Œãã®ã§ã€æ¯ãŒã„ã¤ã‚‚å¿ƒé…ã—ã¦ã„ã‚‹ã€‚"},
  {text:"å½¼å¥³ãŒé§…ã§å¾…ã£ã¦ã„ã‚‹ã¨è¨€ã£ãŸã®ã§ã€ç§ã¯æ€¥ã„ã§è¡Œã£ãŸãŒã€å½¼å¥³ã¯ã‚‚ã†å¸°ã£ã¦ã—ã¾ã£ã¦ã„ãŸã€‚"}
];

var MULTI=["ã‹ã‚‰","ã¾ã§","ã‚ˆã‚Š","ã£ã¦","ã—ã‹","ãªã©"];
var SINGLE=["ã¯","ãŒ","ã‚’","ã«","ã¸","ã§","ã¨","ã‚‚","ã‚„","ã®"];
var ALL=[].concat(MULTI,SINGLE);

var GLOSS={"ã¯":"topic / lens","ãŒ":"identifier / subject","ã‚’":"direct object","ã«":"target / time / existence","ã¸":"direction (towards)","ã§":"place of action / means","ã¨":"and / with / quotative","ã‚‚":"also / even","ã‚„":"non-exhaustive 'and'","ã®":"possessive / attributive","ã‹ã‚‰":"from / since","ã¾ã§":"until / as far as","ã‚ˆã‚Š":"than (comparison)","ã—ã‹":"only (â€¦ãªã„)","ã£ã¦":"informal quotative/topic","ãªã©":"such as / etc."};

// Comprehensive vocabulary dictionary
var VOCAB={
  "ç§":"I/me","çŠ¬":"dog","é›¨":"rain","èŠ±":"flower","æ°´":"water","å‹é”":"friend","å­¦æ ¡":"school","æœ¬":"book","è»Š":"car",
  "æ¯":"mother","å…„":"older brother","å¦¹":"younger sister","å®¶":"home/house","é§…":"station","éŸ³æ¥½":"music","éƒ¨å±‹":"room",
  "æœã”é£¯":"breakfast","å…ˆç”Ÿ":"teacher","çµµ":"picture","çª“":"window","æ–™ç†":"cooking/dish","æ¯æ—¥":"every day",
  "å®¿é¡Œ":"homework","å…¬åœ’":"park","å›³æ›¸é¤¨":"library","æ˜ ç”»é¤¨":"movie theater","çˆ¶":"father","å½¼å¥³":"she/her",
  "æ—¥æœ¬èª":"Japanese language","æ˜¨æ—¥":"yesterday","çŒ«":"cat","é­š":"fish","å¼Ÿ":"younger brother","å§‰":"older sister",
  "æ‰‹ç´™":"letter","å½¼":"he/him","æ±äº¬":"Tokyo","æ­Œ":"song","è²·ã„ç‰©":"shopping","é‹è»¢":"driving","æ•£æ­©":"walk",
  "æ¯æœ":"every morning","ä¸ƒæ™‚":"7 o'clock","å¤§å­¦":"university","çµŒæ¸ˆ":"economics","é§…å‰":"in front of station",
  "ä¸€ç·’":"together","è‹±èª":"English language","å¤•é£¯":"dinner","ãƒ”ã‚¢ãƒ":"piano","ç·´ç¿’":"practice","ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼":"party",
  "ãƒ‘ãƒ³":"bread","ç‰›ä¹³":"milk","æ¯é€±":"every week","æ–°å¹¹ç·š":"bullet train","å¤§é˜ª":"Osaka","ä¸‰å¹´":"3 years","æ¼¢å­—":"kanji",
  "ä»•äº‹":"work/job","å…¨éƒ¨":"all/everything","å®Ÿå®¶":"family home","æ¯é€±æœ«":"every weekend","ä¸­å›½èª":"Chinese language",
  "éŸ“å›½èª":"Korean language","äºˆå®š":"plan/schedule","ã‚²ãƒ¼ãƒ ":"game","å…­æ™‚":"6 o'clock","ã‚¸ãƒ§ã‚®ãƒ³ã‚°":"jogging",
  "æƒé™¤":"cleaning","åº­":"garden/yard","å’æ¥­":"graduation","ä¼šç¤¾":"company","æ™‚":"when/time",
  "é–“":"while/between","å‰":"before","ã ã‘":"only","ã®ã§":"because","ãŸã‚":"for/in order to",

  "èµ°ã‚‹":"run","é™ã‚‹":"fall(rain)","è¦‹ã‚‹":"see/watch","é£²ã‚€":"drink","ä¼šã†":"meet","è¡Œã":"go","å¥½ã":"like",
  "æ¥ã‚‹":"come","ã™ã‚‹":"do","å‡ºã‚‹":"go out/exit","æ­©ã":"walk","èã":"listen/hear","æš—ã„":"dark","é£Ÿã¹ã‚‹":"eat",
  "æ•™ãˆã‚‹":"teach","æã":"draw","é–‹ã‘ã‚‹":"open","éŠã¶":"play","ä½œã‚‹":"make","å€Ÿã‚Šã‚‹":"borrow","å¸°ã‚‹":"return home",
  "ä¸Šæ‰‹":"skilled/good at","å«Œã„":"dislike","æ›¸ã":"write","èª­ã‚€":"read","å¯ã‚‹":"sleep","å‹‰å¼·":"study",
  "è©±ã™":"speak","å§‹ã‚ã‚‹":"begin","èµ·ãã‚‹":"wake up/get up","è²·ã†":"buy","è¨€ã†":"say","æ€ã†":"think",
  "å¾…ã¤":"wait","å¿ƒé…":"worry","é›£ã—ã„":"difficult","ç¾å‘³ã—ã„":"delicious","æ—©ã„":"early/fast",
  "æ–°ã—ã„":"new","ä¹—ã‚‹":"ride/board",

  "ã§ã™":"is/are","ã ":"is/are","ã¦ã„ã‚‹":"doing(continuous)","ã¦ããŸ":"came after doing","ãŸ":"did(past)",
  "ãªã„":"not","ãŒ":"but","ã®ã§":"so/because","æ™‚":"when","ã‚‰":"if/when","ã¦":"and(connector)",
  "ã“ã®":"this","ãã®":"that","ã‚ã®":"that over there","ã©ã®":"which","ã¾ã ":"still/not yet","ã‚‚ã†":"already",
  "ã„ã¤ã‚‚":"always","ã¨ã¦ã‚‚":"very","ã¡ã‚‡ã£ã¨":"a little","ãŸãã•ã‚“":"many/a lot","å°‘ã—":"a little"
};

var DEMO_EXCEPTIONS=["ã“ã®","ãã®","ã‚ã®","ã©ã®","ã“ã‚“ãª","ãã‚“ãª","ã‚ã‚“ãª","ã©ã‚“ãª"];
var SEQ_EXCEPTIONS=["ã§ã™","ã§ã—ãŸ"];
var WORD_EXCEPTIONS=["ãŠã«ãã‚Š","ã®ã‚Š","ã¯ãªã—","ã«ã‚“ã˜ã‚“","ã§ãã‚‹"];

// Meanings used by beta â€œSentence meaningâ€
var MEANINGS={
  "é§…ã¾ã§æ­©ã„ã¦è¡Œãã€‚":"(I) walk to the station.",
  "ã“ã®æœ¬ã¯å¤ªéƒã«ã‚ã’ãŸã€‚":"(I) gave this book to TarÅ.",
  "æ˜¼ã”é£¯ã«ã‚«ãƒ¬ãƒ¼ã‚’é£Ÿã¹ãŸã€‚":"(I) ate curry for lunch.",
  "å…¬åœ’ã§å­ä¾›ã¨éŠã¶ã€‚":"(I) play with children at the park.",
  "ç§ã¯æ—¥æœ¬èªã‚’å‹‰å¼·ã—ã¦ã„ã‚‹ã€‚":"(I) am studying Japanese.",
  "å›³æ›¸é¤¨ã§æœ¬ã‚’å€Ÿã‚ŠãŸã€‚":"(I) borrowed a book at the library.",
  "çŒ«ãŒåº­ã«ã„ã‚‹ã€‚":"A cat is in the yard.",
  "é§…ã‹ã‚‰å®¶ã¾ã§èµ°ã£ãŸã€‚":"(I) ran from the station to home.",
  "æ˜æ—¥å­¦æ ¡ã§ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã€‚":"There is a test at school tomorrow."
};

/* ===== Persistence & state ===== */
var KEY="phSettingsV0729";
var state={
  idx:0,hover:false,showCounts:true,
  cargoShown:false,perGlossSeen:{},persistNotes:false,glossLog:[],
  introSeen:false,myNotesOpen:false,debugMode:true,

  // Timing-based progression system
  level:1,
  startTime:0,
  timePenalty:0,
  recentTimes:[],    // Rolling window of last 12 sentence times
  recentMistakes:[], // Rolling window of last 12 mistake counts

  _storageDisabled:false
};
function save(){if(state._storageDisabled)return;try{localStorage.setItem(KEY,JSON.stringify(state));}catch(e){state._storageDisabled=true;}}
function load(){try{var s=localStorage.getItem(KEY);if(s)Object.assign(state,JSON.parse(s));}catch(e){}}
function factoryReset(){if(!confirm("Factory Reset?"))return;try{localStorage.removeItem(KEY);}catch(e){}location.reload();}

/* ===== Bind settings (sticky) ===== */
function bindSettings(){
  ["hoverHints","showCounts","persistNotes"].forEach(function(id){
    var el=document.getElementById(id); if(!el)return;
    el.addEventListener("change",function(e){
      state[id]=!!e.target.checked; save(); syncUI();
    });
  });
}

/* ===== Helpers & tokenization ===== */
var IDLE_CUTOFF=12.0;
function reserveWords(sentence,used,reserved){
  for(var wi=0;wi<WORD_EXCEPTIONS.length;wi++){
    var w=WORD_EXCEPTIONS[wi],idx=0;
    while(true){var pos=sentence.indexOf(w,idx);if(pos===-1)break;
      reserved.push({start:pos,end:pos+w.length});
      for(var k=0;k<w.length;k++)used[pos+k]=true;
      idx=pos+w.length;
    }
  }
}
function exceptsFor(item){return item.exceptions||[];}
function isExcepted(i,len,exceptions){if(!exceptions.length)return false;var s=i,e=i+len;for(var k=0;k<exceptions.length;k++){var ex=exceptions[k];if(Math.max(s,ex.start)<Math.min(e,ex.end))return true;}return false;}
function annotate(sentence,hardMode,exceptions){
  var ext=tokenizerHook(sentence); if(Array.isArray(ext))return ext;
  var marks=[],used=new Array(sentence.length).fill(false),reserved=[];
  reserveWords(sentence,used,reserved);
  for(var i=0;i<sentence.length;i++){for(var d=0;d<DEMO_EXCEPTIONS.length;d++){var w=DEMO_EXCEPTIONS[d];if(sentence.startsWith(w,i)){reserved.push({start:i,end:i+w.length});for(var k=0;k<w.length;k++)used[i+k]=true;i+=w.length-1;break;}}}
  for(var j=0;j<sentence.length;j++){for(var s=0;s<SEQ_EXCEPTIONS.length;s++){var w2=SEQ_EXCEPTIONS[s];if(sentence.startsWith(w2,j)){reserved.push({start:j,end:j+w2.length});for(var k2=0;k2<w2.length;k2++)used[j+k2]=true;j+=w2.length-1;break;}}}
  function markAt(ii,list){
    for(var li=0;li<list.length;li++){
      var p=list[li];
      if(sentence.startsWith(p,ii)){
        if(isExcepted(ii,p.length,reserved)||isExcepted(ii,p.length,exceptions))continue;
        var ok=true;for(var kk=0;kk<p.length;kk++){if(used[ii+kk]){ok=false;break;}}
        if(!ok)continue;
        for(var kk2=0;kk2<p.length;kk2++)used[ii+kk2]=true;
        marks.push({start:ii,end:ii+p.length,text:p});return p.length;
      }
    } return 0;
  }
  for(var x=0;x<sentence.length;x++){var adv=markAt(x,MULTI);if(adv)x+=adv-1;}
  for(var y=0;y<sentence.length;y++){if(used[y])continue;var ch=sentence[y];
    if(SINGLE.indexOf(ch)>-1 && !isExcepted(y,1,reserved) && !isExcepted(y,1,exceptions)){
      used[y]=true;marks.push({start:y,end:y+1,text:ch});
    }
  }
  marks.sort(function(a,b){return a.start-b.start;});
  var tokens=[],idx=0;
  for(var m=0;m<marks.length;m++){
    var mk=marks[m];
    if(idx<mk.start){
      var chunk=sentence.slice(idx,mk.start);
      if(hardMode){for(var ci=0;ci<chunk.length;ci++)tokens.push({text:chunk[ci],isParticle:false});}
      else{tokens.push({text:chunk,isParticle:false});}
    }
    tokens.push({text:sentence.slice(mk.start,mk.end),isParticle:true});
    idx=mk.end;
  }
  if(idx<sentence.length){
    var tail=sentence.slice(idx);
    if(hardMode){for(var ti=0;ti<tail.length;ti++)tokens.push({text:tail[ti],isParticle:false});}
    else{tokens.push({text:tail,isParticle:false});}
  }
  return tokens;
}

/* ===== UI state ===== */
var tokens=[],picked=new Set(),currentMistakes=0;
function updatePill(){
  var names=["","Beginner","Intermediate","Advanced","Expert"];
  document.getElementById("modePill").textContent="Level "+state.level+": "+names[state.level];
}
function renderNotes(items){
  var block=document.getElementById("notesBlock"),list=document.getElementById("notesList");
  list.innerHTML=""; if(!items.length){block.style.display="none";return;}
  for(var i=0;i<items.length;i++){var li=document.createElement("li");li.textContent=items[i];list.appendChild(li);}
  block.style.display="block";
}
function buildUnlockedNotes(){var keys=[];for(var k in state.perGlossSeen){if(state.perGlossSeen[k])keys.push(k);}var order=MULTI.concat(SINGLE);keys.sort(function(a,b){return order.indexOf(a)-order.indexOf(b);});var out=[];for(var i=0;i<keys.length;i++){var key=keys[i];out.push(key+" = "+(GLOSS[key]||"particle"));}return out;}
function renderMyNotes(){var list=document.getElementById("myNotesList");list.innerHTML="";var all=buildUnlockedNotes();if(!all.length){var li=document.createElement("li");li.textContent="No notes unlocked yet.";list.appendChild(li);return;}for(var i=0;i<all.length;i++){var li2=document.createElement("li");li2.textContent=all[i];list.appendChild(li2);}}
function resetNextBtn(){var n=document.getElementById("nextBtn");n.classList.remove("next-success");n.classList.remove("next-warn");}
function clearAccPills(){var pills=document.querySelectorAll("#stats .pill");for(var i=0;i<pills.length;i++){var txt=(pills[i].textContent||"").trim();if(txt.indexOf("Acc ")===0)pills[i].remove();}}
function syncUI(){
  document.body.classList.toggle("noHover",!state.hover);
  document.getElementById("hoverHints").checked=!!state.hover;
  document.getElementById("showCounts").checked=!!state.showCounts;
  document.getElementById("persistNotes").checked=!!state.persistNotes;

  updatePill();
  document.getElementById("debugCard").style.display="block";
  document.getElementById("settingsCard").style.display="block";
  document.getElementById("debugState").textContent=state.debugMode?"ON":"OFF";

  document.getElementById("myNotesBlock").style.display=state.myNotesOpen?"block":"none";
  document.getElementById("toggleMyNotesBtn").textContent=state.myNotesOpen?"Hide my notes":"Show my notes";

  var dbg=document.getElementById("debugArea");
  if(state.showCounts){
    var count=tokens.filter(function(t){return t.isParticle;}).length;
    var avgTime=state.recentTimes.length>0?(state.recentTimes.reduce(function(a,b){return a+b;},0)/state.recentTimes.length).toFixed(2):"--";
    dbg.textContent="v0.7.29 | Level "+state.level+" | Particles: "+count+" | Avg: "+avgTime+"s/p | History: "+state.recentTimes.length+"/12";
  }else{dbg.textContent="v0.7.29 | Level "+state.level;}
}

/* ===== Bank ===== */
function currentBank(){
  // Level-specific sentence banks
  var base=[];
  if(state.level===1){
    base=CORE.concat(LEVEL1_EXT);
  }else if(state.level===2){
    base=CORE.concat(LEVEL1_EXT).concat(TRAPS).concat(LEVEL2_EXT);
  }else if(state.level===3){
    base=LEVEL3_EXT;
  }else if(state.level===4){
    base=LEVEL3_EXT.concat(TRAPS).concat(LEVEL4_EXT);
  }
  return base;
}

/* ===== Round flow ===== */
function render(force){
  if(typeof force==="undefined")force=false;
  clearAccPills(); var bd=document.getElementById("breakdownBox"); if(bd)bd.style.display="none";
  var bank=currentBank(); if(!bank.length){document.getElementById("sentence").textContent="(no sentences)";return;}
  if(!force) state.idx=(state.idx+1)%bank.length;
  var item=bank[state.idx], sentence=item.text; state._lastSentence=sentence;
  // Levels 3 & 4 use character-level splitting (hard mode)
  var hardMode=state.level>=3;
  tokens=annotate(sentence,hardMode,exceptsFor(item)); picked.clear();

  // Start timer and reset penalty
  state.startTime=Date.now();
  state.timePenalty=0;
  currentMistakes=0;

  var c=document.getElementById("sentence"); c.innerHTML="";
  for(var i=0;i<tokens.length;i++){
    (function(i){
      var t=tokens[i],sp=document.createElement("span");
      sp.className="token"; sp.textContent=t.text;
      sp.addEventListener("pointerdown",function(){
        if(sp.classList.contains("good")||sp.classList.contains("bad")||sp.classList.contains("miss"))return;

        if(picked.has(i)){
          picked.delete(i);
          sp.classList.remove("picked");
        }else{
          picked.add(i);
          sp.classList.add("picked");

          // Wrong click penalty: +2s and red flash
          if(!t.isParticle){
            currentMistakes++;
            state.timePenalty+=2000; // 2 seconds in ms
            sp.classList.add("bad");
            setTimeout(function(){sp.classList.remove("bad","picked");},300);
            picked.delete(i);
            return;
          }

          // Check if all particles found â†’ auto-submit
          checkCompletion();
        }
      });
      c.appendChild(sp);
    })(i);
  }
  document.getElementById("nextBtn").disabled=true;
  document.getElementById("showBreakdownBtn").disabled=true;
  resetNextBtn(); document.getElementById("cargoBanner").classList.remove("show");
  syncUI();
}
function checkCompletion(){
  // Count total particles and picked particles
  var totalParticles=tokens.filter(function(t){return t.isParticle;}).length;
  var pickedParticles=0;
  for(var i=0;i<tokens.length;i++){
    if(tokens[i].isParticle && picked.has(i))pickedParticles++;
  }

  // Auto-submit when all particles found
  if(pickedParticles===totalParticles){
    setTimeout(function(){completeRound();},150); // Slight delay for visual feedback
  }
}
function completeRound(){
  var mistakes=currentMistakes;
  // Calculate time taken (with penalties)
  var elapsed=Date.now()-state.startTime+state.timePenalty;
  var particleCount=tokens.filter(function(t){return t.isParticle;}).length;
  var timePerParticle=particleCount>0?(elapsed/particleCount)/1000:0; // Convert to seconds

  // Visual feedback
  var spans=[].slice.call(document.querySelectorAll("#sentence .token")),newGlosses=[];
  function addGloss(key){if(ALL.indexOf(key)>-1 && !state.perGlossSeen[key]){var gloss=GLOSS[key]||"particle";var line=key+" = "+gloss;newGlosses.push(line);state.perGlossSeen[key]=true;}}
  for(var i=0;i<tokens.length;i++){
    if(tokens[i].isParticle){
      spans[i].classList.add("good");
      addGloss(tokens[i].text);
    }
  }

  // Rolling window tracking
  state.recentTimes.push(timePerParticle);
  state.recentMistakes.push(mistakes);
  if(state.recentTimes.length>12){state.recentTimes.shift();state.recentMistakes.shift();}

  // Show timing feedback
  var timePill=document.createElement("span");
  timePill.className="pill";
  timePill.textContent=timePerParticle.toFixed(2)+"s per particle";
  document.getElementById("stats").appendChild(timePill);

  // Evaluate and adjust difficulty
  evaluatePerformance();

  // Notes and UI
  if(state.persistNotes){for(var g=0;g<newGlosses.length;g++){if(state.glossLog.indexOf(newGlosses[g])===-1)state.glossLog.push(newGlosses[g]);}renderNotes(state.glossLog);}else{renderNotes(newGlosses);}
  if(state.myNotesOpen)renderMyNotes();

  // Enable breakdown and next
  document.getElementById("showBreakdownBtn").disabled=false;
  document.getElementById("nextBtn").disabled=false;

  save(); syncUI();
}
function evaluatePerformance(){
  // Need at least 8 rounds for evaluation
  if(state.recentTimes.length<8)return;

  var avgTime=state.recentTimes.reduce(function(a,b){return a+b;},0)/state.recentTimes.length;
  var totalMistakes=state.recentMistakes.reduce(function(a,b){return a+b;},0);

  // Level up thresholds (avg time per particle)
  var thresholds=[999,3.0,2.0,1.5,1.0]; // index 0 unused, 1-4 are levels

  // Try to level up
  if(state.level<4 && avgTime<thresholds[state.level+1]){
    state.level++;
    state.idx=0; // Reset to first sentence
  }
  // Level down on too many mistakes
  else if(state.level>1 && totalMistakes>=4){
    state.level--;
    state.idx=0;
    // Clear mistake history after regression
    state.recentMistakes=state.recentMistakes.map(function(){return 0;});
  }
}
function showBreakdown(){
  // Umi-style token-by-token breakdown
  var box=document.getElementById("breakdownBox");
  var content=document.getElementById("breakdownContent");
  if(box.style.display==="block"){
    box.style.display="none";
    return;
  }
  var lines=[];
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i];
    var meaning="";
    if(t.isParticle){
      meaning=GLOSS[t.text]||"particle";
    }else if(VOCAB[t.text]){
      meaning=VOCAB[t.text];
    }else{
      meaning="â€”";
    }
    lines.push('<div style="display:flex;border-bottom:1px solid #e5e7eb;padding:.4rem 0;"><div style="min-width:120px;font-weight:500;">'+t.text+'</div><div style="color:#6b7280;border-left:2px solid #d1d5db;padding-left:.75rem;">'+meaning+'</div></div>');
  }
  content.innerHTML=lines.join("");
  box.style.display="block";
}

/* ===== Controls ===== */
document.getElementById("nextBtn").onclick=function(){render(false);};
document.getElementById("showBreakdownBtn").onclick=showBreakdown;
document.getElementById("toggleParticlesBtn").onclick=function(){var card=document.getElementById("particleListCard");card.style.display=card.style.display==="none"?"block":"none";};
document.getElementById("toggleMyNotesBtn").onclick=function(){state.myNotesOpen=!state.myNotesOpen;save();if(state.myNotesOpen)renderMyNotes();syncUI();};
document.getElementById("factoryBtn").addEventListener("click",factoryReset);
document.getElementById("copyDebugBtn").addEventListener("click",function(){
  var payload={version:"v0.7.29",sentence:(currentBank()[state.idx]||{}).text,settings:state,tokens:tokens.map(function(t){return {t:t.text,p:t.isParticle};}),picked:Array.from(picked),glossLog:state.glossLog};
  var text=JSON.stringify(payload,null,2);
  if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){document.getElementById("debugArea").textContent="Copied debug snapshot:\n"+text;}).catch(function(){document.getElementById("debugArea").textContent="Copy failed. Here it is:\n"+text;});}
  else{document.getElementById("debugArea").textContent="Clipboard not available. Here it is:\n"+text;}
});
document.getElementById("toggleDebugBtn").onclick=function(){state.debugMode=!state.debugMode;save();syncUI();};
document.addEventListener("keydown",function(e){
  var tag=(e.target&&e.target.tagName)?e.target.tagName.toLowerCase():""; if(tag==="input"||tag==="textarea")return;
  var k=(e.key||"").toLowerCase();
  if((k===" "||k==="n") && !document.getElementById("nextBtn").disabled){
    e.preventDefault();
    render(false);
  }
});

/* ===== Boot ===== */
try{
  load();
  (function boot(){
    document.getElementById("gameCard").style.display="block";
    document.getElementById("settingsCard").style.display="block";
    document.getElementById("debugCard").style.display="block";
    document.getElementById("startBtn").onclick=function(){state.introSeen=true;save();document.getElementById("introCard").style.display="none";render(true);};
    if(state.introSeen){document.getElementById("introCard").style.display="none";}
    bindSettings(); syncUI(); render(true);
  })();
}catch(e){console.error(e);showErr(e.message||String(e));}
</script>
</body>
</html>
