<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Particle Hunter — v0.7.29 (Auto-Submit + Timing-Based Progression)</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",Meiryo,sans-serif;background:#f7f7f9;margin:0;color:#222}
  header{background:#fff;border-bottom:1px solid #e5e7eb;padding:.75rem 1rem;position:sticky;top:0;z-index:10}
  .head{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
  h1{margin:0;font-size:1.05rem}
  main{max-width:980px;margin:0 auto;padding:1.25rem}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .sentence{font-size:1.6rem;user-select:none}
  .token{display:inline-block;border-radius:6px;cursor:pointer;transition:background .12s,box-shadow .12s}
  body:not(.noHover) .token:hover{background:#f0f9ff;box-shadow:inset 0 0 0 1px #bae6fd}
  .picked{background:#e0f2fe;box-shadow:inset 0 0 0 1px #7dd3fc}
  .good{background:#dcfce7!important;box-shadow:inset 0 0 0 1px #86efac!important}
  .bad{box-shadow:inset 0 0 0 2px #f87171!important}
  .miss{background:#fecaca!important;box-shadow:inset 0 0 0 1px #ef4444!important}
  button{border:1px solid #d1d5db;background:#fff;padding:.55rem .8rem;border-radius:10px;cursor:pointer;font-size:.95rem}
  button.primary{background:#111827;color:#fff;border-color:#111827}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .5rem;border:1px solid #e5e7eb;border-radius:999px;font-size:.85rem;background:#fff}
  .stats{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
  .muted{color:#6b7280;font-size:.9rem}
  .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;justify-content:space-between}
  .banner{display:none;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;padding:.6rem .8rem;border-radius:10px;margin:.75rem 0}
  .banner.show{display:block}
  .banner.good{border-color:#bbf7d0;background:#f0fdf4;color:#065f46}
  .debug{font-family:ui-monospace,monospace;font-size:.85rem;white-space:pre-wrap;background:#f9fafb;border:1px dashed #e5e7eb;padding:.5rem;border-radius:8px;color:#374151}
  .next-success{box-shadow:0 0 0 2px #22c55e inset}
  .next-warn{box-shadow:0 0 0 2px #fbbf24 inset}
  #breakdownBox.bd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;white-space:pre-wrap}
  #err{display:none;margin:0;padding:.6rem .8rem;background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px}
  #err.show{display:block}
</style>
</head>
<body class="noHover">
<header>
  <div class="head">
    <h1>Particle Hunter <span class="muted">v0.7.29</span> <span class="pill" id="modePill">Core</span></h1>
    <button id="toggleDebugBtn">Debug Mode: <span id="debugState">ON</span></button>
  </div>
</header>

<main>
  <p id="err"></p>

  <div id="introCard" class="card intro">
    <h2>🌸 The Goal</h2>
    <p><strong>Think in Japanese by reading Japanese.</strong> English relies on word order; Japanese relies on tiny glue-words. Train your eyes to find them first.</p>
    <div class="example" style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:.6rem .8rem;margin:.5rem 0;font-family:ui-monospace,monospace;font-size:.95rem;">
      犬<strong>が</strong> 人<strong>を</strong> 噛んだ<br/>人<strong>を</strong> 犬<strong>が</strong> 噛んだ<br/>
      <span class="muted">Both read “The dog bit the man.” The glue-words anchor roles.</span>
    </div>
    <button id="startBtn" class="primary">Start</button>
  </div>

  <div class="card" id="gameCard">
    <div class="row">
      <div class="muted"><strong>Goal:</strong> Click all particles as fast as you can! Auto-advances when complete.</div>
      <div class="pill"><span>Keys:</span> <strong>Space</strong> or <strong>N</strong> next sentence</div>
    </div>

    <div id="cargoBanner" class="banner" role="alert"><strong>Hey, you left cargo on the platform!</strong></div>
    <div id="streamBanner" class="banner" role="alert" style="display:none;"></div>
    <div id="levelBanner" class="banner good" role="status">Mastery achieved — Level 2 unlocked.</div>

    <div class="sentence" id="sentence"></div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap;">
      <button id="nextBtn">Next</button>
      <button id="showBreakdownBtn" disabled>Show breakdown</button>
      <button id="toggleParticlesBtn">Show particle list</button>
      <button id="toggleMyNotesBtn">Show my notes</button>
    </div>

    <div class="stats" id="stats"></div>
    <div id="breakdownBox" class="card" style="display:none;margin-top:.75rem;padding:1rem;background:#f9fafb;">
      <strong>Sentence Breakdown</strong>
      <div id="breakdownContent" style="margin-top:.5rem;font-family:ui-monospace,monospace;"></div>
    </div>

    <div class="notes" id="notesBlock" style="display:none;">
      <h4>Notes</h4><ul id="notesList"></ul>
    </div>

    <div class="card" id="particleListCard" style="display:none;margin-top:.75rem;">
      <strong>Particle reference</strong>
      <div class="muted">Multi-character first, then singles. Ambiguities like 「には」 are treated as に + は.</div>
      <ul class="muted">
        <li>Multi-char: から, まで, より, って, しか, など</li>
        <li>Single-char: は, が, を, に, へ, で, と, も, や, の</li>
      </ul>
    </div>

    <div class="myNotes" id="myNotesBlock" style="display:none;margin-top:.75rem;">
      <h4>My Notes (unlocked this session)</h4><ul id="myNotesList"></ul>
    </div>
  </div>

  <div class="card" id="settingsCard">
    <strong>Settings</strong>
    <div class="muted">Auto-advances on completion. Level up by improving speed (avg time/particle). Level 1-2: grouped. Level 3-4: character-split.</div>
    <div style="display:grid;gap:.4rem;margin-top:.5rem;">
      <label><input type="checkbox" id="hoverHints"> Enable hover highlights</label>
      <label><input type="checkbox" id="showCounts" checked> Show timing stats in debug</label>
      <label><input type="checkbox" id="persistNotes"> Keep stacked gloss notes (session)</label>
    </div>
  </div>

  <div class="card" id="debugCard">
    <strong>Debug</strong>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0;">
      <button id="copyDebugBtn">Copy debug snapshot</button>
      <button id="factoryBtn">Factory Reset (first-run)</button>
    </div>
    <div id="debugArea" class="debug">Ready.</div>
  </div>
</main>

<script>
/* ===== Visible error so failures never look blank ===== */
function showErr(msg){var el=document.getElementById('err');el.textContent="Script error: "+msg;el.className="show";}

/* ===== Optional external tokenizer hook ===== */
function tokenizerHook(sentence){return null;}

/* ===== Core data ===== */
var CORE=[
  {text:"私は日本語を勉強している。"},
  {text:"明日学校でテストがある。"},
  {text:"駅まで歩いて行く。"},
  {text:"友達と映画を見た。"},
  {text:"図書館で本を借りた。"},
  {text:"昼ご飯にカレーを食べた。"},
  {text:"猫が庭にいる。"},
  {text:"東京へ引っ越した。"},
  {text:"七時に起きて、会社へ行く。"},
  {text:"この本は太郎にあげた。"},
  {text:"親より背が高い。"},
  {text:"牛乳しか飲まない。"},
  {text:"駅から家まで走った。"},
  {text:"先生とも話した。"},
  {text:"日本の文化について学ぶ。"},
  {text:"明日も仕事がある。"},
  {text:"これは私のです。"},
  {text:"公園で子供と遊ぶ。"}
];
var TRAPS=[
  {text:"にんじんを食べる。",exceptions:[{start:0,end:1}]},
  {text:"ノートにのりをつけた。",exceptions:[{start:4,end:5}]},
  {text:"できるだけ早く帰る。",exceptions:[{start:0,end:1}]},
  {text:"この本を読んだ。",exceptions:[{start:0,end:2}]},
  {text:"その映画は面白い。",exceptions:[{start:0,end:2}]}
];

// Extended sentence banks by level
var LEVEL1_EXT=[
  {text:"犬が走る。"},{text:"雨が降る。"},{text:"花を見る。"},{text:"水を飲む。"},
  {text:"友達に会う。"},{text:"学校へ行く。"},{text:"本が好きだ。"},{text:"車で来た。"},
  {text:"母と買い物する。"},{text:"兄も来る。"},{text:"妹の鞄だ。"},{text:"家から出る。"},
  {text:"駅まで歩く。"},{text:"音楽を聞く。"},{text:"部屋が暗い。"},{text:"朝ご飯を食べる。"},
  {text:"先生が教える。"},{text:"絵を描く。"},{text:"窓を開ける。"},{text:"友達と遊ぶ。"}
];
var LEVEL2_EXT=[
  {text:"母が料理を作っている。"},{text:"兄は毎日走っている。"},{text:"妹も宿題をする。"},
  {text:"犬が公園で遊んでいる。"},{text:"私は本を図書館で借りた。"},{text:"友達と映画館へ行った。"},
  {text:"父が会社から帰ってきた。"},{text:"彼女は日本語が上手だ。"},{text:"昨日も雨が降った。"},
  {text:"猫が魚を食べている。"},{text:"弟は学校が嫌いだ。"},{text:"姉が手紙を書いた。"},
  {text:"彼は東京から来た。"},{text:"私も歌が好きだ。"},{text:"先生が本を読んでいる。"},
  {text:"母が買い物に行った。"},{text:"兄が車を運転する。"},{text:"友達の家へ行く。"},
  {text:"毎日公園を散歩する。"},{text:"駅から走って来た。"}
];
var LEVEL3_EXT=[
  {text:"彼は毎朝七時に起きて、会社へ行く。"},{text:"私の母は料理が上手で、毎日美味しいものを作る。"},
  {text:"友達が図書館で勉強している時、私は家で寝ていた。"},{text:"兄は東京の大学で経済を勉強している。"},
  {text:"昨日駅前で友達に会って、一緒に映画を見た。"},{text:"彼女は日本語と英語が話せる。"},
  {text:"父が会社から帰ってきたら、夕飯を食べる。"},{text:"妹は毎日ピアノを練習しているが、まだ上手ではない。"},
  {text:"公園で犬と遊んでいる子供たちを見た。"},{text:"明日は友達の家でパーティーがある。"},
  {text:"私は朝ご飯にパンと牛乳を食べた。"},{text:"彼は本を読むのが好きで、毎週図書館に行く。"},
  {text:"母が買い物から帰ってきて、料理を始めた。"},{text:"兄が新しい車を買ったので、私も乗せてもらった。"},
  {text:"駅まで歩いて行くより、バスで行く方が早い。"}
];
var LEVEL4_EXT=[
  {text:"私の父は毎朝六時に起きて、会社に行く前にジョギングをしている。"},
  {text:"友達が東京から大阪まで新幹線で行った時、私も一緒に行きたかったが、仕事があって行けなかった。"},
  {text:"彼女は日本語の勉強を始めてから三年になるが、まだ漢字を読むのが難しいと言っている。"},
  {text:"昨日図書館で本を借りようと思ったが、読みたい本が全部貸し出されていたので、諦めて帰った。"},
  {text:"母が料理を作っている間に、私は部屋を掃除して、父は庭で花に水をやっていた。"},
  {text:"兄は大学を卒業してから東京の会社で働いているが、毎週末は実家に帰ってくる。"},
  {text:"彼は日本語が上手に話せるだけではなく、中国語も韓国語も勉強している。"},
  {text:"明日友達と映画を見に行く予定だったが、雨が降りそうなので、家でゲームをすることにした。"},
  {text:"私は朝ご飯を食べてから学校に行くが、弟は食べないで行くので、母がいつも心配している。"},
  {text:"彼女が駅で待っていると言ったので、私は急いで行ったが、彼女はもう帰ってしまっていた。"}
];

var MULTI=["から","まで","より","って","しか","など"];
var SINGLE=["は","が","を","に","へ","で","と","も","や","の"];
var ALL=[].concat(MULTI,SINGLE);

var GLOSS={"は":"topic / lens","が":"identifier / subject","を":"direct object","に":"target / time / existence","へ":"direction (towards)","で":"place of action / means","と":"and / with / quotative","も":"also / even","や":"non-exhaustive 'and'","の":"possessive / attributive","から":"from / since","まで":"until / as far as","より":"than (comparison)","しか":"only (…ない)","って":"informal quotative/topic","など":"such as / etc."};

// Comprehensive vocabulary dictionary
var VOCAB={
  "私":"I/me","犬":"dog","雨":"rain","花":"flower","水":"water","友達":"friend","学校":"school","本":"book","車":"car",
  "母":"mother","兄":"older brother","妹":"younger sister","家":"home/house","駅":"station","音楽":"music","部屋":"room",
  "朝ご飯":"breakfast","先生":"teacher","絵":"picture","窓":"window","料理":"cooking/dish","毎日":"every day",
  "宿題":"homework","公園":"park","図書館":"library","映画館":"movie theater","父":"father","彼女":"she/her",
  "日本語":"Japanese language","昨日":"yesterday","猫":"cat","魚":"fish","弟":"younger brother","姉":"older sister",
  "手紙":"letter","彼":"he/him","東京":"Tokyo","歌":"song","買い物":"shopping","運転":"driving","散歩":"walk",
  "毎朝":"every morning","七時":"7 o'clock","大学":"university","経済":"economics","駅前":"in front of station",
  "一緒":"together","英語":"English language","夕飯":"dinner","ピアノ":"piano","練習":"practice","パーティー":"party",
  "パン":"bread","牛乳":"milk","毎週":"every week","新幹線":"bullet train","大阪":"Osaka","三年":"3 years","漢字":"kanji",
  "仕事":"work/job","全部":"all/everything","実家":"family home","毎週末":"every weekend","中国語":"Chinese language",
  "韓国語":"Korean language","予定":"plan/schedule","ゲーム":"game","六時":"6 o'clock","ジョギング":"jogging",
  "掃除":"cleaning","庭":"garden/yard","卒業":"graduation","会社":"company","時":"when/time",
  "間":"while/between","前":"before","だけ":"only","ので":"because","ため":"for/in order to",

  "走る":"run","降る":"fall(rain)","見る":"see/watch","飲む":"drink","会う":"meet","行く":"go","好き":"like",
  "来る":"come","する":"do","出る":"go out/exit","歩く":"walk","聞く":"listen/hear","暗い":"dark","食べる":"eat",
  "教える":"teach","描く":"draw","開ける":"open","遊ぶ":"play","作る":"make","借りる":"borrow","帰る":"return home",
  "上手":"skilled/good at","嫌い":"dislike","書く":"write","読む":"read","寝る":"sleep","勉強":"study",
  "話す":"speak","始める":"begin","起きる":"wake up/get up","買う":"buy","言う":"say","思う":"think",
  "待つ":"wait","心配":"worry","難しい":"difficult","美味しい":"delicious","早い":"early/fast",
  "新しい":"new","乗る":"ride/board",

  "です":"is/are","だ":"is/are","ている":"doing(continuous)","てきた":"came after doing","た":"did(past)",
  "ない":"not","が":"but","ので":"so/because","時":"when","ら":"if/when","て":"and(connector)",
  "この":"this","その":"that","あの":"that over there","どの":"which","まだ":"still/not yet","もう":"already",
  "いつも":"always","とても":"very","ちょっと":"a little","たくさん":"many/a lot","少し":"a little"
};

var DEMO_EXCEPTIONS=["この","その","あの","どの","こんな","そんな","あんな","どんな"];
var SEQ_EXCEPTIONS=["です","でした"];
var WORD_EXCEPTIONS=["おにぎり","のり","はなし","にんじん","できる"];

// Meanings used by beta “Sentence meaning”
var MEANINGS={
  "駅まで歩いて行く。":"(I) walk to the station.",
  "この本は太郎にあげた。":"(I) gave this book to Tarō.",
  "昼ご飯にカレーを食べた。":"(I) ate curry for lunch.",
  "公園で子供と遊ぶ。":"(I) play with children at the park.",
  "私は日本語を勉強している。":"(I) am studying Japanese.",
  "図書館で本を借りた。":"(I) borrowed a book at the library.",
  "猫が庭にいる。":"A cat is in the yard.",
  "駅から家まで走った。":"(I) ran from the station to home.",
  "明日学校でテストがある。":"There is a test at school tomorrow."
};

/* ===== Persistence & state ===== */
var KEY="phSettingsV0729";
var state={
  idx:0,hover:false,showCounts:true,
  cargoShown:false,perGlossSeen:{},persistNotes:false,glossLog:[],
  introSeen:false,myNotesOpen:false,debugMode:true,

  // Timing-based progression system
  level:1,
  startTime:0,
  timePenalty:0,
  recentTimes:[],    // Rolling window of last 12 sentence times
  recentMistakes:[], // Rolling window of last 12 mistake counts

  _storageDisabled:false
};
function save(){if(state._storageDisabled)return;try{localStorage.setItem(KEY,JSON.stringify(state));}catch(e){state._storageDisabled=true;}}
function load(){try{var s=localStorage.getItem(KEY);if(s)Object.assign(state,JSON.parse(s));}catch(e){}}
function factoryReset(){if(!confirm("Factory Reset?"))return;try{localStorage.removeItem(KEY);}catch(e){}location.reload();}

/* ===== Bind settings (sticky) ===== */
function bindSettings(){
  ["hoverHints","showCounts","persistNotes"].forEach(function(id){
    var el=document.getElementById(id); if(!el)return;
    el.addEventListener("change",function(e){
      state[id]=!!e.target.checked; save(); syncUI();
    });
  });
}

/* ===== Helpers & tokenization ===== */
var IDLE_CUTOFF=12.0;
function reserveWords(sentence,used,reserved){
  for(var wi=0;wi<WORD_EXCEPTIONS.length;wi++){
    var w=WORD_EXCEPTIONS[wi],idx=0;
    while(true){var pos=sentence.indexOf(w,idx);if(pos===-1)break;
      reserved.push({start:pos,end:pos+w.length});
      for(var k=0;k<w.length;k++)used[pos+k]=true;
      idx=pos+w.length;
    }
  }
}
function exceptsFor(item){return item.exceptions||[];}
function isExcepted(i,len,exceptions){if(!exceptions.length)return false;var s=i,e=i+len;for(var k=0;k<exceptions.length;k++){var ex=exceptions[k];if(Math.max(s,ex.start)<Math.min(e,ex.end))return true;}return false;}
function annotate(sentence,hardMode,exceptions){
  var ext=tokenizerHook(sentence); if(Array.isArray(ext))return ext;
  var marks=[],used=new Array(sentence.length).fill(false),reserved=[];
  reserveWords(sentence,used,reserved);
  for(var i=0;i<sentence.length;i++){for(var d=0;d<DEMO_EXCEPTIONS.length;d++){var w=DEMO_EXCEPTIONS[d];if(sentence.startsWith(w,i)){reserved.push({start:i,end:i+w.length});for(var k=0;k<w.length;k++)used[i+k]=true;i+=w.length-1;break;}}}
  for(var j=0;j<sentence.length;j++){for(var s=0;s<SEQ_EXCEPTIONS.length;s++){var w2=SEQ_EXCEPTIONS[s];if(sentence.startsWith(w2,j)){reserved.push({start:j,end:j+w2.length});for(var k2=0;k2<w2.length;k2++)used[j+k2]=true;j+=w2.length-1;break;}}}
  function markAt(ii,list){
    for(var li=0;li<list.length;li++){
      var p=list[li];
      if(sentence.startsWith(p,ii)){
        if(isExcepted(ii,p.length,reserved)||isExcepted(ii,p.length,exceptions))continue;
        var ok=true;for(var kk=0;kk<p.length;kk++){if(used[ii+kk]){ok=false;break;}}
        if(!ok)continue;
        for(var kk2=0;kk2<p.length;kk2++)used[ii+kk2]=true;
        marks.push({start:ii,end:ii+p.length,text:p});return p.length;
      }
    } return 0;
  }
  for(var x=0;x<sentence.length;x++){var adv=markAt(x,MULTI);if(adv)x+=adv-1;}
  for(var y=0;y<sentence.length;y++){if(used[y])continue;var ch=sentence[y];
    if(SINGLE.indexOf(ch)>-1 && !isExcepted(y,1,reserved) && !isExcepted(y,1,exceptions)){
      used[y]=true;marks.push({start:y,end:y+1,text:ch});
    }
  }
  marks.sort(function(a,b){return a.start-b.start;});
  var tokens=[],idx=0;
  for(var m=0;m<marks.length;m++){
    var mk=marks[m];
    if(idx<mk.start){
      var chunk=sentence.slice(idx,mk.start);
      if(hardMode){for(var ci=0;ci<chunk.length;ci++)tokens.push({text:chunk[ci],isParticle:false});}
      else{tokens.push({text:chunk,isParticle:false});}
    }
    tokens.push({text:sentence.slice(mk.start,mk.end),isParticle:true});
    idx=mk.end;
  }
  if(idx<sentence.length){
    var tail=sentence.slice(idx);
    if(hardMode){for(var ti=0;ti<tail.length;ti++)tokens.push({text:tail[ti],isParticle:false});}
    else{tokens.push({text:tail,isParticle:false});}
  }
  return tokens;
}

/* ===== UI state ===== */
var tokens=[],picked=new Set(),currentMistakes=0;
function updatePill(){
  var names=["","Beginner","Intermediate","Advanced","Expert"];
  document.getElementById("modePill").textContent="Level "+state.level+": "+names[state.level];
}
function renderNotes(items){
  var block=document.getElementById("notesBlock"),list=document.getElementById("notesList");
  list.innerHTML=""; if(!items.length){block.style.display="none";return;}
  for(var i=0;i<items.length;i++){var li=document.createElement("li");li.textContent=items[i];list.appendChild(li);}
  block.style.display="block";
}
function buildUnlockedNotes(){var keys=[];for(var k in state.perGlossSeen){if(state.perGlossSeen[k])keys.push(k);}var order=MULTI.concat(SINGLE);keys.sort(function(a,b){return order.indexOf(a)-order.indexOf(b);});var out=[];for(var i=0;i<keys.length;i++){var key=keys[i];out.push(key+" = "+(GLOSS[key]||"particle"));}return out;}
function renderMyNotes(){var list=document.getElementById("myNotesList");list.innerHTML="";var all=buildUnlockedNotes();if(!all.length){var li=document.createElement("li");li.textContent="No notes unlocked yet.";list.appendChild(li);return;}for(var i=0;i<all.length;i++){var li2=document.createElement("li");li2.textContent=all[i];list.appendChild(li2);}}
function resetNextBtn(){var n=document.getElementById("nextBtn");n.classList.remove("next-success");n.classList.remove("next-warn");}
function clearAccPills(){var pills=document.querySelectorAll("#stats .pill");for(var i=0;i<pills.length;i++){var txt=(pills[i].textContent||"").trim();if(txt.indexOf("Acc ")===0)pills[i].remove();}}
function syncUI(){
  document.body.classList.toggle("noHover",!state.hover);
  document.getElementById("hoverHints").checked=!!state.hover;
  document.getElementById("showCounts").checked=!!state.showCounts;
  document.getElementById("persistNotes").checked=!!state.persistNotes;

  updatePill();
  document.getElementById("debugCard").style.display="block";
  document.getElementById("settingsCard").style.display="block";
  document.getElementById("debugState").textContent=state.debugMode?"ON":"OFF";

  document.getElementById("myNotesBlock").style.display=state.myNotesOpen?"block":"none";
  document.getElementById("toggleMyNotesBtn").textContent=state.myNotesOpen?"Hide my notes":"Show my notes";

  var dbg=document.getElementById("debugArea");
  if(state.showCounts){
    var count=tokens.filter(function(t){return t.isParticle;}).length;
    var avgTime=state.recentTimes.length>0?(state.recentTimes.reduce(function(a,b){return a+b;},0)/state.recentTimes.length).toFixed(2):"--";
    dbg.textContent="v0.7.29 | Level "+state.level+" | Particles: "+count+" | Avg: "+avgTime+"s/p | History: "+state.recentTimes.length+"/12";
  }else{dbg.textContent="v0.7.29 | Level "+state.level;}
}

/* ===== Bank ===== */
function currentBank(){
  // Level-specific sentence banks
  var base=[];
  if(state.level===1){
    base=CORE.concat(LEVEL1_EXT);
  }else if(state.level===2){
    base=CORE.concat(LEVEL1_EXT).concat(TRAPS).concat(LEVEL2_EXT);
  }else if(state.level===3){
    base=LEVEL3_EXT;
  }else if(state.level===4){
    base=LEVEL3_EXT.concat(TRAPS).concat(LEVEL4_EXT);
  }
  return base;
}

/* ===== Round flow ===== */
function render(force){
  if(typeof force==="undefined")force=false;
  clearAccPills(); var bd=document.getElementById("breakdownBox"); if(bd)bd.style.display="none";
  var bank=currentBank(); if(!bank.length){document.getElementById("sentence").textContent="(no sentences)";return;}
  if(!force) state.idx=(state.idx+1)%bank.length;
  var item=bank[state.idx], sentence=item.text; state._lastSentence=sentence;
  // Levels 3 & 4 use character-level splitting (hard mode)
  var hardMode=state.level>=3;
  tokens=annotate(sentence,hardMode,exceptsFor(item)); picked.clear();

  // Start timer and reset penalty
  state.startTime=Date.now();
  state.timePenalty=0;
  currentMistakes=0;

  var c=document.getElementById("sentence"); c.innerHTML="";
  for(var i=0;i<tokens.length;i++){
    (function(i){
      var t=tokens[i],sp=document.createElement("span");
      sp.className="token"; sp.textContent=t.text;
      sp.addEventListener("pointerdown",function(){
        if(sp.classList.contains("good")||sp.classList.contains("bad")||sp.classList.contains("miss"))return;

        if(picked.has(i)){
          picked.delete(i);
          sp.classList.remove("picked");
        }else{
          picked.add(i);
          sp.classList.add("picked");

          // Wrong click penalty: +2s and red flash
          if(!t.isParticle){
            currentMistakes++;
            state.timePenalty+=2000; // 2 seconds in ms
            sp.classList.add("bad");
            setTimeout(function(){sp.classList.remove("bad","picked");},300);
            picked.delete(i);
            return;
          }

          // Check if all particles found → auto-submit
          checkCompletion();
        }
      });
      c.appendChild(sp);
    })(i);
  }
  document.getElementById("nextBtn").disabled=true;
  document.getElementById("showBreakdownBtn").disabled=true;
  resetNextBtn(); document.getElementById("cargoBanner").classList.remove("show");
  syncUI();
}
function checkCompletion(){
  // Count total particles and picked particles
  var totalParticles=tokens.filter(function(t){return t.isParticle;}).length;
  var pickedParticles=0;
  for(var i=0;i<tokens.length;i++){
    if(tokens[i].isParticle && picked.has(i))pickedParticles++;
  }

  // Auto-submit when all particles found
  if(pickedParticles===totalParticles){
    setTimeout(function(){completeRound();},150); // Slight delay for visual feedback
  }
}
function completeRound(){
  var mistakes=currentMistakes;
  // Calculate time taken (with penalties)
  var elapsed=Date.now()-state.startTime+state.timePenalty;
  var particleCount=tokens.filter(function(t){return t.isParticle;}).length;
  var timePerParticle=particleCount>0?(elapsed/particleCount)/1000:0; // Convert to seconds

  // Visual feedback
  var spans=[].slice.call(document.querySelectorAll("#sentence .token")),newGlosses=[];
  function addGloss(key){if(ALL.indexOf(key)>-1 && !state.perGlossSeen[key]){var gloss=GLOSS[key]||"particle";var line=key+" = "+gloss;newGlosses.push(line);state.perGlossSeen[key]=true;}}
  for(var i=0;i<tokens.length;i++){
    if(tokens[i].isParticle){
      spans[i].classList.add("good");
      addGloss(tokens[i].text);
    }
  }

  // Rolling window tracking
  state.recentTimes.push(timePerParticle);
  state.recentMistakes.push(mistakes);
  if(state.recentTimes.length>12){state.recentTimes.shift();state.recentMistakes.shift();}

  // Show timing feedback
  var timePill=document.createElement("span");
  timePill.className="pill";
  timePill.textContent=timePerParticle.toFixed(2)+"s per particle";
  document.getElementById("stats").appendChild(timePill);

  // Evaluate and adjust difficulty
  evaluatePerformance();

  // Notes and UI
  if(state.persistNotes){for(var g=0;g<newGlosses.length;g++){if(state.glossLog.indexOf(newGlosses[g])===-1)state.glossLog.push(newGlosses[g]);}renderNotes(state.glossLog);}else{renderNotes(newGlosses);}
  if(state.myNotesOpen)renderMyNotes();

  // Enable breakdown and next
  document.getElementById("showBreakdownBtn").disabled=false;
  document.getElementById("nextBtn").disabled=false;

  save(); syncUI();
}
function evaluatePerformance(){
  // Need at least 8 rounds for evaluation
  if(state.recentTimes.length<8)return;

  var avgTime=state.recentTimes.reduce(function(a,b){return a+b;},0)/state.recentTimes.length;
  var totalMistakes=state.recentMistakes.reduce(function(a,b){return a+b;},0);

  // Level up thresholds (avg time per particle)
  var thresholds=[999,3.0,2.0,1.5,1.0]; // index 0 unused, 1-4 are levels

  // Try to level up
  if(state.level<4 && avgTime<thresholds[state.level+1]){
    state.level++;
    state.idx=0; // Reset to first sentence
  }
  // Level down on too many mistakes
  else if(state.level>1 && totalMistakes>=4){
    state.level--;
    state.idx=0;
    // Clear mistake history after regression
    state.recentMistakes=state.recentMistakes.map(function(){return 0;});
  }
}
function showBreakdown(){
  // Umi-style token-by-token breakdown
  var box=document.getElementById("breakdownBox");
  var content=document.getElementById("breakdownContent");
  if(box.style.display==="block"){
    box.style.display="none";
    return;
  }
  var lines=[];
  for(var i=0;i<tokens.length;i++){
    var t=tokens[i];
    var meaning="";
    if(t.isParticle){
      meaning=GLOSS[t.text]||"particle";
    }else if(VOCAB[t.text]){
      meaning=VOCAB[t.text];
    }else{
      meaning="—";
    }
    lines.push('<div style="display:flex;border-bottom:1px solid #e5e7eb;padding:.4rem 0;"><div style="min-width:120px;font-weight:500;">'+t.text+'</div><div style="color:#6b7280;border-left:2px solid #d1d5db;padding-left:.75rem;">'+meaning+'</div></div>');
  }
  content.innerHTML=lines.join("");
  box.style.display="block";
}

/* ===== Controls ===== */
document.getElementById("nextBtn").onclick=function(){render(false);};
document.getElementById("showBreakdownBtn").onclick=showBreakdown;
document.getElementById("toggleParticlesBtn").onclick=function(){var card=document.getElementById("particleListCard");card.style.display=card.style.display==="none"?"block":"none";};
document.getElementById("toggleMyNotesBtn").onclick=function(){state.myNotesOpen=!state.myNotesOpen;save();if(state.myNotesOpen)renderMyNotes();syncUI();};
document.getElementById("factoryBtn").addEventListener("click",factoryReset);
document.getElementById("copyDebugBtn").addEventListener("click",function(){
  var payload={version:"v0.7.29",sentence:(currentBank()[state.idx]||{}).text,settings:state,tokens:tokens.map(function(t){return {t:t.text,p:t.isParticle};}),picked:Array.from(picked),glossLog:state.glossLog};
  var text=JSON.stringify(payload,null,2);
  if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(function(){document.getElementById("debugArea").textContent="Copied debug snapshot:\n"+text;}).catch(function(){document.getElementById("debugArea").textContent="Copy failed. Here it is:\n"+text;});}
  else{document.getElementById("debugArea").textContent="Clipboard not available. Here it is:\n"+text;}
});
document.getElementById("toggleDebugBtn").onclick=function(){state.debugMode=!state.debugMode;save();syncUI();};
document.addEventListener("keydown",function(e){
  var tag=(e.target&&e.target.tagName)?e.target.tagName.toLowerCase():""; if(tag==="input"||tag==="textarea")return;
  var k=(e.key||"").toLowerCase();
  if((k===" "||k==="n") && !document.getElementById("nextBtn").disabled){
    e.preventDefault();
    render(false);
  }
});

/* ===== Boot ===== */
try{
  load();
  (function boot(){
    document.getElementById("gameCard").style.display="block";
    document.getElementById("settingsCard").style.display="block";
    document.getElementById("debugCard").style.display="block";
    document.getElementById("startBtn").onclick=function(){state.introSeen=true;save();document.getElementById("introCard").style.display="none";render(true);};
    if(state.introSeen){document.getElementById("introCard").style.display="none";}
    bindSettings(); syncUI(); render(true);
  })();
}catch(e){console.error(e);showErr(e.message||String(e));}
</script>
</body>
</html>
